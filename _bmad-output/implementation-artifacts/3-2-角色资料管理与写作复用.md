# Story 3.2: 角色资料管理与写作复用

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 创作者用户,
I want 管理角色资料并在写作中复用,
so that 人物行为和语气保持一致。

## Acceptance Criteria

1. **Given** 用户在项目内维护角色档案，**When** 用户新增、编辑或删除角色信息，**Then** 角色信息可在 AI 上下文中被正确注入。
2. **And** 当角色冲突或缺失时系统提供可理解提示与修复建议（FR10, NFR12）。

## Tasks / Subtasks

- [x] Task 1: 完成角色资料 CRUD 闭环并保持权限隔离（AC: 1）
  - [x] 1.1 在 `story-bible` 面板中补全角色创建/编辑/删除交互，字段覆盖 name、role、description、personality、appearance、backstory、goals、relationships、notes。
  - [x] 1.2 在 Server Action 层统一校验登录态并通过 `user_id` 边界执行写操作，返回中文可执行错误信息。
  - [x] 1.3 确保写入后 UI 状态同步与必要的 `revalidatePath` 刷新，避免列表与数据库状态漂移。
- [x] Task 2: 保证角色资料被 AI 上下文稳定消费（AC: 1）
  - [x] 2.1 校验 `fetchStoryContext` 对 characters 查询与字段映射完整性，避免遗漏关键画像字段。
  - [x] 2.2 校验 `buildStoryPromptContext` 在 writing/planning/check/chat 场景下的角色注入规则与上限行为（最多 15 个角色）。
  - [x] 2.3 校验 `visibility.characters` 开关行为：关闭时不注入角色上下文，开启时注入且格式稳定。
- [x] Task 3: 提供角色冲突/缺失提示与修复建议（AC: 2）
  - [x] 3.1 在角色编辑与保存失败路径输出可执行提示（例如刷新重试、补全必填字段、检查重名冲突）。
  - [x] 3.2 在 AI 结果异常路径中，为角色信息不足或冲突提供最小修复建议文案。
  - [x] 3.3 统一错误语义，避免“只报错不指路”。
- [x] Task 4: 验证与回归（AC: all）
  - [x] 4.1 增加/更新角色相关自动化测试（Server Action + 关键上下文组装断言）。
  - [x] 4.2 运行 `npm run lint` 与 `npm run build`。
  - [x] 4.3 手测新增、编辑、删除角色后触发 AI 调用，确认角色信息在输出中可观测生效。

### Review Follow-ups (AI)

- [x] [AI-Review][CRITICAL] Task 1.1 标记字段覆盖完整，但 UI 编辑链路未提供 `name` 与 `role` 编辑入口，需补齐并验证保存流程。 [`writeteam/src/components/story-bible/story-bible-panel.tsx:525`]
- [x] [AI-Review][CRITICAL] Task 4.1 标记“Server Action + 关键上下文断言”已完成，但缺少 `createCharacter`/`updateCharacter`/`deleteCharacter` 的鉴权与用户隔离自动化测试。 [`writeteam/src/app/actions/story-bible.test.ts:1`]
- [x] [AI-Review][HIGH] 角色重名冲突仅应用层预检，缺少数据库唯一约束，存在并发写入窗口导致冲突漏检风险。 [`writeteam/src/app/actions/story-bible.ts:105`]
- [x] [AI-Review][HIGH] `updateCharacter` 未覆盖重名冲突场景，允许编辑为同项目同用户重复名称，和 AC2 的“冲突提示与修复建议”不一致。 [`writeteam/src/app/actions/story-bible.ts:132`]

## Dev Notes

- 本故事承接 Story 3.1，目标是在现有 `characters` 表与 Story Bible 面板能力上增强角色治理，不引入并行数据模型。
- 本故事是 Epic 3 的第二个故事，需继承 3.1 已建立的守护模式：并发冲突可感知、写入字段受控、错误可执行。
- 角色信息是 `buildStoryPromptContext` 的核心输入之一，任何字段变更都需验证 writing/planning/check/chat 四类特性注入行为。

### Project Structure Notes

- 主要变更范围应优先落在：
  - `writeteam/src/components/story-bible/story-bible-panel.tsx`
  - `writeteam/src/app/actions/story-bible.ts`
  - `writeteam/src/lib/ai/story-context.ts`
  - `writeteam/src/app/api/ai/*/route.ts`（仅在需要补齐角色异常提示时）
- 禁止新增 `middleware.ts`；项目使用 Next.js 16 `proxy.ts` 约定。
- 若出现 schema 调整，必须追加 migration 并同步 `writeteam/src/types/database.ts`。

### References

- [Source: `_bmad-output/planning-artifacts/epics.md`#Epic 3: 故事知识库与设定治理]
- [Source: `_bmad-output/planning-artifacts/epics.md`#Story 3.2: 角色资料管理与写作复用]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Data Architecture]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Authentication & Security]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Implementation Patterns & Consistency Rules]
- [Source: `_bmad-output/planning-artifacts/ux-design-specification.md`#失败恢复不断流（差异化关键路径）]
- [Source: `_bmad-output/project-context.md`#Critical Don't-Miss Rules]

## Developer Context Section

### Technical Requirements

- 角色 CRUD 必须复用现有 `story-bible` action 分层与 Supabase RLS 边界，不得引入绕过鉴权的数据写入路径。
- 角色更新必须显式维护 `updated_at`，并保持返回值对 UI 可消费（成功/失败/冲突态）。
- AI 上下文组装需保持 token 节制：角色数量上限、字段按 feature 裁剪、长文本字段避免无界注入。

### Architecture Compliance

- 严格遵循 AI 调用链：`auth -> resolveAIConfig -> fetchStoryContext -> buildStoryPromptContext -> createOpenAIStreamResponse`。
- 所有 Server Action 在 DB 操作前执行 `supabase.auth.getUser()` 门禁，且查询/更新必须带 `user_id` 约束。
- 继续遵循“失败恢复主流程”UX 原则：失败提示必须包含下一步动作。

### Library / Framework Requirements

- Next.js 16：使用 `proxy.ts` 进行会话保护；Server Action 中进行鉴权与授权，不将授权仅留给客户端。
- Supabase：所有角色数据表保持 RLS 开启；写策略使用 `WITH CHECK` 约束写入主体与边界字段。
- TypeScript strict：避免未约束的 `Record<string, unknown>` 直接写库；优先白名单映射。

### File Structure Requirements

- UI 角色交互留在 `components/story-bible`，数据变更留在 `app/actions/story-bible.ts`，上下文拼装留在 `lib/ai/story-context.ts`。
- 若新增测试，遵循现有测试放置约定并确保与源能力同域维护。

### Testing Requirements

- 至少覆盖：
  - `createCharacter`/`updateCharacter`/`deleteCharacter` 鉴权与用户隔离。
  - `buildStoryPromptContext` 在 feature 维度对角色字段裁剪逻辑。
  - `visibility.characters` 开关对注入结果的影响。
- 回归验证必须包含 `npm run lint` 与 `npm run build`。

## Previous Story Intelligence

- 来自 Story 3.1 的关键经验：
  - 冲突检测后不能“假成功”，必须进入明确冲突态并给出刷新/重试动作。
  - 写入字段需白名单化，避免通过宽泛 updates 覆盖受保护字段。
  - 文档状态字段需一致，避免 `Status` 与 completion 状态冲突导致流程误判。
  - 对并发场景补充自动化测试可显著降低回归风险。

## Git Intelligence Summary

- 最近提交显示 Epic 3 已有安全加固方向（并发保护、字段白名单、RLS policy with check），本故事应复用该模式而非回退到宽松写入。
- 近几次故事实现均同步更新实现文档与 `sprint-status.yaml`，保持追踪一致性是既有流程规范。

## Latest Tech Information

- Next.js 16 推荐在 Server Action 中执行鉴权与授权判断，并在变更后通过缓存/重渲染机制更新页面状态。  
  Source: https://github.com/vercel/next.js/blob/v16.1.6/docs/01-app/02-guides/authentication.mdx
- Next.js 16 认证保护主线使用 `proxy.ts` 路由保护约定，不应新增过时 `middleware.ts` 实现。  
  Source: https://github.com/vercel/next.js/blob/v16.1.6/docs/01-app/02-guides/authentication.mdx
- Supabase RLS 策略建议显式检查 `auth.uid() IS NOT NULL`，并对写入策略使用 `WITH CHECK` 防止越权写入。  
  Source: https://github.com/supabase/supabase/blob/master/apps/docs/content/guides/database/postgres/row-level-security.mdx
- Supabase 多租户 CRUD 应以 `user_id` 作为核心边界列，并保持 insert/update/delete 全路径策略覆盖。  
  Source: https://github.com/supabase/supabase/blob/master/examples/todo-list/sveltejs-todo-list/README.md

## Project Context Reference

- [Source: `_bmad-output/project-context.md`#Framework-Specific Rules (Next.js 16 / React 19)]
- [Source: `_bmad-output/project-context.md`#BYOK 数据流]
- [Source: `_bmad-output/project-context.md`#Security Rules]

## Story Completion Status

- Story status 已设置为：`done`
- Completion note：Auto-fix 已完成全部 Critical/High 项，AC 与任务声明一致性已恢复并通过自动化验证。

## Dev Agent Record

### Agent Model Used

gpt-5.3-codex

### Debug Log References

- create-story: 已读取 `workflow.yaml`、`instructions.xml`、`template.md`、`checklist.md`。
- create-story: 已自动发现首个 backlog 故事 `3-2-角色资料管理与写作复用`。
- create-story: 已分析 `epics.md`、`architecture.md`、`ux-design-specification.md`、`project-context.md`、上一故事文档与最近提交。
- create-story: 已补充 Next.js 16 与 Supabase RLS 最新实现守护栏。
- dev-story: 已将 `sprint-status.yaml` 中故事 `3-2-角色资料管理与写作复用` 更新为 `in-progress`。
- dev-story: 已在 `story-bible` action 层引入角色字段白名单、重名预检、中文可执行错误映射与 `revalidatePath` 同步。
- dev-story: 已补全角色创建弹窗字段覆盖（name/role/description/personality/appearance/backstory/goals/relationships/notes）并补齐备注编辑入口。
- dev-story: 已在 `buildStoryPromptContext` 增加角色冲突/缺失提示文案，并补充 visibility.characters 与规划场景注入断言测试。
- dev-story: 已执行 `npm run test`、`npm run lint`、`npm run build`，测试 12/12 通过，lint 0 error（存在项目既有 2 条 warning），build 成功。
- code-review-fix: 已补齐角色编辑入口 `name`/`role`，并保持 `CharacterField` 统一交互模式。
- code-review-fix: 已新增 `story-bible.actions.test.ts`，覆盖 `createCharacter`/`updateCharacter`/`deleteCharacter` 鉴权与用户隔离断言。
- code-review-fix: 已为角色重名冲突新增数据库唯一索引 migration，并补齐 `updateCharacter` 重名冲突校验与中文可执行提示。
- code-review-fix: 已重新执行 `npm --prefix writeteam run test`、`npm run lint`、`npm run build`，测试 17/17 通过，lint 0 error（2 条既有 warning），build 成功。

### Completion Notes List

- 已完成：故事目标与验收标准提炼。
- 已完成：开发守护栏（技术、架构、库框架、目录、测试）编排。
- 已完成：上一故事经验与近期提交模式提炼，纳入本故事约束。
- 已完成：角色 CRUD 输入字段覆盖与服务端字段白名单治理，防止越权字段写入并统一失败恢复提示。
- 已完成：角色创建重名预检与更新/删除错误语义统一，确保失败路径可执行（刷新重试、补全字段、检查命名冲突）。
- 已完成：角色上下文注入稳定性增强（visibility 开关、planning 字段裁剪、冲突/缺失提示）及自动化断言覆盖。
- 已完成手测：使用账号 `writeteam.test+1772046095607@example.com` 配置 DeepSeek 后，执行“新增角色→编辑性格→触发 AI 对话→删除角色→再次 AI 对话”链路，输出可观测体现角色注入与缺失修复建议。
- 已完成：评审回合 Auto-fix，关闭 2 Critical + 2 High 问题并同步故事与冲刺状态。

### File List

- `_bmad-output/implementation-artifacts/3-2-角色资料管理与写作复用.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `writeteam/src/app/actions/story-bible-guards.ts`
- `writeteam/src/app/actions/story-bible.ts`
- `writeteam/src/components/story-bible/story-bible-panel.tsx`
- `writeteam/src/lib/ai/story-context.ts`
- `writeteam/src/app/actions/story-bible.test.ts`
- `writeteam/src/lib/ai/story-context.test.ts`
- `writeteam/src/app/actions/story-bible.actions.test.ts`
- `writeteam/vitest.config.ts`
- `writeteam/package.json`
- `writeteam/supabase/migrations/013_characters_unique_name_per_project.sql`

## Change Log

- 2026-02-28: 完成角色资料 CRUD 强化、角色上下文注入稳定性增强、自动化测试补齐与在线手测闭环，故事状态推进至 review。
- 2026-02-28: Senior Developer Review（AI）执行完毕，结论为 Changes Requested；新增 4 条 Review Follow-ups（2 Critical / 2 High），状态回退为 in-progress。
- 2026-02-28: 已执行自动修复（Auto-fix），完成全部 Critical/High 项闭环并通过回归验证，状态更新为 done。

## Senior Developer Review (AI)

### Reviewer

- Reviewer: Elij (AI Senior Developer Review)
- Date: 2026-02-28
- Outcome: Changes Requested

### Review Summary

- Git 与 Story File List 基本一致，但已完成任务声明与实现证据存在关键偏差。
- AC1/AC2 存在部分未闭环项：角色冲突治理在并发与更新路径上仍有缺口。
- 自动化测试通过（12/12），但对 Server Action 鉴权与隔离的核心断言尚未覆盖。

### Findings

- [CRITICAL] Task 1.1 声称字段覆盖完整，但角色编辑面板未提供 `name`、`role` 编辑入口，属于“标记完成但未实现完整范围”。 [`writeteam/src/components/story-bible/story-bible-panel.tsx:525`]
- [CRITICAL] Task 4.1 声称已覆盖 Server Action 关键测试，实际缺少 CRUD 鉴权与用户隔离断言。 [`writeteam/src/app/actions/story-bible.test.ts:1`]
- [HIGH] `createCharacter` 的重名冲突依赖应用层查询，无数据库唯一约束兜底，并发下可能漏拦截。 [`writeteam/src/app/actions/story-bible.ts:105`]
- [HIGH] `updateCharacter` 未对重名冲突做校验/映射，不能稳定满足 AC2 对冲突提示与修复建议要求。 [`writeteam/src/app/actions/story-bible.ts:132`]

### Validation Evidence

- `npm --prefix writeteam run test`：通过（2 files, 12 tests）
- `npm run lint`：通过（0 errors, 2 项项目既有 warning）
- `npm run build`：通过（Next.js build success）

### Auto-fix Verification (AI)

- Fix Outcome: 已完成全部 4 条 Follow-ups（2 Critical / 2 High）
- Updated Evidence:
  - `npm --prefix writeteam run test`：通过（3 files, 17 tests）
  - `npm run lint`：通过（0 errors, 2 项项目既有 warning）
  - `npm run build`：通过（Next.js build success）
- Final Outcome: Approved after fixes
