# Story 2.1: 写作项目管理

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 创作者用户,
I want 创建、查看、重命名和删除写作项目,
so that 我可以按作品组织创作工作。

## Acceptance Criteria

1. **Given** 用户已登录并进入工作区，**When** 用户通过"新建项目"按钮填写标题、简介和题材后提交，**Then** 项目在列表中实时出现，创建同时自动生成默认 Story Bible 和第 1 章文档，项目列表按最近更新排序（FR4）。
2. **Given** 用户在项目卡片上看到已有项目，**When** 用户通过项目卡片的操作菜单选择"重命名"，**Then** 弹出重命名对话框，用户可修改项目标题，确认后列表标题实时更新且不影响项目内容与关联数据（FR4）。
3. **Given** 用户在项目卡片上看到已有项目，**When** 用户通过项目卡片的操作菜单选择"编辑信息"，**Then** 弹出编辑对话框，用户可修改项目标题、简介和题材，确认后项目信息持久化且列表实时反映变更（FR4）。
4. **Given** 用户在项目卡片上看到已有项目，**When** 用户通过操作菜单选择"删除"，**Then** 系统弹出二次确认对话框，明确告知将永久删除项目及其全部内容，用户确认后项目从列表中移除，取消则无任何副作用（FR4）。
5. **Given** 用户执行新增、重命名、编辑或删除操作，**When** 操作因网络或服务端原因失败，**Then** 系统通过 toast 通知显示中文错误信息且不破坏当前页面状态；进行中的操作显示加载指示器以防止重复提交（FR4, NFR12）。
6. **Given** 多个用户各自登录，**When** 各自执行项目管理操作，**Then** 每位用户仅能看到和操作自己创建的项目，数据完全隔离（NFR6）。

## Tasks / Subtasks

- [x] **Task 1: 新增项目重命名功能**（AC: 2, 5）
  - [x] 1.1 在 `dashboard-content.tsx` 的项目卡片 DropdownMenu 中新增"重命名"菜单项（使用 `PenLine` 图标）
  - [x] 1.2 新增重命名对话框状态管理（`renameDialogOpen`、`projectToRename`、`renameTitle`）
  - [x] 1.3 实现 `handleRenameProject()` 函数：构造 FormData（仅包含新 title + 保留原 description/genre），调用已有 `updateProject()` Server Action
  - [x] 1.4 成功后更新本地 `projects` state 中对应项目的 title 和 updated_at，显示 toast 成功通知
  - [x] 1.5 失败时通过 toast.error 显示中文错误信息，不关闭对话框
  - [x] 1.6 加载中禁用提交按钮并显示 Loader2 动画

- [x] **Task 2: 新增项目信息编辑功能**（AC: 3, 5）
  - [x] 2.1 在 `dashboard-content.tsx` 的项目卡片 DropdownMenu 中新增"编辑信息"菜单项（使用 `Settings` 图标或合适图标）
  - [x] 2.2 新增编辑对话框，表单包含标题（Input, required）、简介（Textarea）、题材（Select, 复用 GENRES 常量），预填当前项目数据
  - [x] 2.3 新增编辑对话框状态管理（`editDialogOpen`、`projectToEdit`）
  - [x] 2.4 实现 `handleEditProject()` 函数：构造 FormData，调用已有 `updateProject()` Server Action
  - [x] 2.5 成功后更新本地 `projects` state 中对应项目的 title/description/genre/updated_at，显示 toast 成功通知，关闭对话框
  - [x] 2.6 失败时通过 toast.error 显示中文错误信息，不关闭对话框
  - [x] 2.7 加载中禁用提交按钮并显示 Loader2 动画

- [x] **Task 3: 优化已有功能与交互细节**（AC: 1, 4, 5, 6）
  - [x] 3.1 确认创建项目流程正常（已有功能，回归校验）：Dialog 表单 → createProject → 列表更新 → 跳转编辑器
  - [x] 3.2 确认删除项目流程正常（已有功能，回归校验）：DropdownMenu → AlertDialog 确认 → deleteProject → 列表移除 → toast 通知
  - [x] 3.3 在创建和删除操作的 loading 状态期间，禁止多个并发操作（确认 `loading` state 覆盖所有操作）
  - [x] 3.4 确认 RLS 策略在项目查询和变更中的正确生效（`user_id = auth.uid()`）

- [x] **Task 4: 交付校验**（AC: all）
  - [x] 4.1 运行 `npm run lint`（0 errors）
  - [x] 4.2 运行 `npm run build`（通过）
  - [x] 4.3 手动验证：新建项目 → 列表出现 → 自动跳转编辑器
  - [x] 4.4 手动验证：重命名项目 → 列表标题更新 → 项目内容不变
  - [x] 4.5 手动验证：编辑项目信息 → 标题/简介/题材更新 → 列表反映变更
  - [x] 4.6 手动验证：删除项目 → 确认对话框 → 列表移除 → 取消则无副作用
  - [x] 4.7 手动验证：操作失败场景 → toast 错误通知 → 页面状态不受影响

## Dev Notes

- **这是一个 Brownfield 增量增强 Story**。项目管理的后端 Server Actions（createProject/updateProject/deleteProject/getProjects）已全部存在于 `src/app/actions/projects.ts`，本 Story 的核心工作是补齐前端 UI 缺口（重命名 + 编辑信息）并确保已有 CRUD 闭环完整可用。
- **不需要新增 Server Action 或 API Route** — `updateProject(projectId, formData)` 已支持修改 title/description/genre，直接复用即可。
- **不需要新增 DB migration** — `projects` 表结构完全满足 FR4 的所有字段需求。
- **不需要新增独立页面** — 项目管理在 Dashboard 页面内通过对话框完成（而非导航到 `/projects/[id]` 详情页），保持写作主链路的简洁性。如果用户需要查看项目详情，点击项目卡片已直接进入编辑器。
- **操作隔离** — 重命名、编辑、删除使用独立的 state 和 Dialog/AlertDialog，避免状态交叉污染。loading state 应区分各操作类型（可改为操作类型枚举或每个操作独立 loading），也可保持共享 loading（当前实现方式）防止并发。
- **不引入新依赖** — 所有 UI 使用已有 shadcn/ui 组件（Dialog、AlertDialog、Input、Textarea、Select、Button、DropdownMenu、Card）和已有工具库（sonner、date-fns、lucide-react）。

### Project Structure Notes

#### 修改文件
| 文件 | 路径 | 变更 |
|------|------|------|
| dashboard-content.tsx | `src/components/dashboard/` | 新增重命名对话框 + 编辑信息对话框 + DropdownMenu 菜单项扩展 + 对应状态和处理函数 |

#### 不应修改的文件
- `src/app/actions/projects.ts` — Server Actions 已满足需求，不需修改
- `src/app/(dashboard)/dashboard/page.tsx` — 数据获取逻辑不变
- `src/app/(dashboard)/layout.tsx` — auth guard 不变
- `src/types/database.ts` — Project 类型不变
- `proxy.ts` — 不涉及请求拦截变更
- 任何 `src/app/api/` 下的文件 — 不涉及 API 变更

### References

- [Source: _bmad-output/planning-artifacts/epics.md#Story 2.1: 写作项目管理]
- [Source: _bmad-output/planning-artifacts/prd.md#FR4 项目管理]
- [Source: _bmad-output/planning-artifacts/architecture.md#Structure Patterns]
- [Source: _bmad-output/planning-artifacts/architecture.md#Naming Patterns]
- [Source: _bmad-output/planning-artifacts/ux-design-specification.md#Form Patterns]
- [Source: _bmad-output/planning-artifacts/ux-design-specification.md#Feedback Patterns]
- [Source: _bmad-output/project-context.md#Server Action 固定模式]
- [Source: _bmad-output/project-context.md#shadcn/ui 组件规则]

## Developer Context Section

### Technical Requirements

- **仅修改 1 个文件**：`src/components/dashboard/dashboard-content.tsx`。所有 UI 变更集中在此文件。
- **复用已有 `updateProject()` Server Action**：签名为 `updateProject(projectId: string, formData: FormData)`，接受 `title`、`description`、`genre` 三个字段，自动 revalidate `/dashboard` 和 `/projects/${projectId}`。
- **本地 state 乐观更新**：操作成功后直接以 `setProjects()` 更新列表（与现有 create/delete 模式一致），无需等待页面刷新。
- **中文 UI 文案**：所有用户可见文本使用中文。

### Architecture Compliance

- **Server Action 模式不变**：`updateProject` 内部已包含 auth check（`supabase.auth.getUser()`）、DB 变更、`revalidatePath()` — 前端只需构造 FormData 并调用。
- **RLS 数据隔离不变**：`projects` 表的 RLS 策略强制 `user_id = auth.uid()`，任何查询和变更都自动过滤到当前用户。
- **组件边界不变**：`DashboardContent` 是客户端组件（`"use client"`），通过 props 接收服务端预取的 projects 数据，通过 Server Actions 执行变更。
- **BYOK 无关**：本 Story 不涉及 AI 配置或调用。

### Library / Framework Requirements

- Next.js: 16.1.6（App Router + Server Actions）
- React: 19.2.x（`useState`）
- shadcn/ui: v3.8.5（new-york style）— Dialog, AlertDialog, Input, Textarea, Select, Button, DropdownMenu, Card
- Lucide React: ^0.575.0 — PenLine（重命名图标）、FileEdit 或 Pencil（编辑图标）
- Sonner: v2 — toast.success / toast.error
- date-fns: v4 — formatDistanceToNow + zhCN locale
- TypeScript: strict mode
- **不引入新依赖**

### File Structure Requirements

- 所有变更在 `src/components/dashboard/dashboard-content.tsx` 内完成
- 不创建新文件
- 不创建新目录
- 文件名保持 kebab-case

### Testing Requirements

- 交付门禁：`npm run lint`（0 errors）+ `npm run build`（通过）
- 手动验证：创建 → 重命名 → 编辑 → 删除全流程
- 手动验证：操作失败场景的错误反馈
- 确认 loading 状态防止重复提交

## Previous Story Intelligence

### Epic 1 完成经验

- **Story 1.1-1.4** 建立了稳定的工程基线：lint 0 errors + build 通过是强制交付门禁。
- **Code Review 教训**：每个用户可见的错误信息必须是中文，且必须包含可执行的下一步动作建议。
- **组件模式**：所有交互组件使用 shadcn/ui 基元（Button、Dialog、AlertDialog、Input 等），不创建并行体系。
- **状态管理模式**：使用 `useState` 管理本地组件状态，不引入全局状态管理。
- **Server Action 调用模式**：通过 FormData 传参 → 检查返回的 `error` 字段 → 成功则更新 state + toast.success → 失败则 toast.error。

### 现有 Dashboard 代码分析

当前 `dashboard-content.tsx`（387 行）已实现：
- **创建项目**：Dialog 表单 → `handleCreateProject()` → `createProject(formData)` → 乐观更新 + 跳转编辑器
- **删除项目**：DropdownMenu "删除" → AlertDialog 确认 → `handleDeleteProject()` → `deleteProject(id)` → 列表移除
- **项目列表**：Card 网格展示，显示标题、题材、简介、更新时间
- **空态**：无项目时显示引导创建按钮

**缺失的功能（本 Story 的实现目标）**：
- DropdownMenu 中只有"删除"选项，没有"重命名"和"编辑信息"
- 没有调用已有的 `updateProject()` Server Action 的任何 UI 入口

### 实现参考模式

新增功能应严格遵循现有代码中已建立的模式：

```typescript
// 状态声明模式（参考现有 delete 模式）
const [renameDialogOpen, setRenameDialogOpen] = useState(false)
const [projectToRename, setProjectToRename] = useState<Project | null>(null)

// 处理函数模式（参考现有 handleDeleteProject）
async function handleRenameProject(newTitle: string) {
  if (!projectToRename) return
  setLoading(true)
  const formData = new FormData()
  formData.append("title", newTitle)
  formData.append("description", projectToRename.description || "")
  formData.append("genre", projectToRename.genre || "")
  const result = await updateProject(projectToRename.id, formData)
  if (result.error) {
    toast.error(result.error)
  } else {
    setProjects(projects.map(p =>
      p.id === projectToRename.id
        ? { ...p, title: newTitle, updated_at: new Date().toISOString() }
        : p
    ))
    toast.success("项目已重命名")
    setRenameDialogOpen(false)
  }
  setProjectToRename(null)
  setLoading(false)
}

// DropdownMenu 扩展模式（在现有"删除"前添加）
<DropdownMenuItem onClick={(e) => {
  e.stopPropagation()
  setProjectToRename(project)
  setRenameDialogOpen(true)
}}>
  <PenLine className="mr-2 h-4 w-4" />
  重命名
</DropdownMenuItem>
```

## Git Intelligence Summary

- 最近提交：`9bf73fb` Story 1-4 完成，`2544abe` Story 1-3 完成，`8fd16cf` Story 1-2 完成，`e940978` Story 1-1 完成。
- Epic 1 已完成并标记为 done — Epic 2 现在开始。
- 代码库稳定：lint 0 errors，build 通过。
- `dashboard-content.tsx` 在 Story 1-1 中创建并在后续 Story 中未被修改 — 本 Story 是首次增强此文件。

## Existing Code Inventory (Brownfield Context)

本 Story 直接依赖以下已有代码，开发者必须在修改前阅读理解：

| 文件 | 路径 | 与本 Story 的关系 |
|------|------|------------------|
| dashboard-content.tsx | `src/components/dashboard/` | **核心修改点** — 新增重命名和编辑信息的 UI 交互 |
| projects.ts | `src/app/actions/` | **依赖（只读）** — 复用 updateProject() Server Action，不修改 |
| dashboard/page.tsx | `src/app/(dashboard)/` | **依赖（只读）** — 理解数据加载流程，不修改 |
| database.ts | `src/types/` | **依赖（只读）** — Project 类型定义，不修改 |

### updateProject Server Action 签名参考

```typescript
// src/app/actions/projects.ts（已有，不修改）
export async function updateProject(projectId: string, formData: FormData) {
  // 1. Auth check: supabase.auth.getUser()
  // 2. 从 formData 提取 title, description, genre
  // 3. supabase.from("projects").update({ title, description, genre, updated_at }).eq("id", projectId).eq("user_id", user.id)
  // 4. revalidatePath("/dashboard") + revalidatePath(`/projects/${projectId}`)
  // 5. 返回 { success: true } 或 { error: "..." }
}
```

### Project 类型参考

```typescript
// src/types/database.ts（已有，不修改）
export type Project = {
  id: string
  user_id: string
  title: string
  description: string | null
  genre: string | null
  cover_image_url: string | null
  word_count_goal: number | null
  preferred_model: string | null
  series_id: string | null
  created_at: string
  updated_at: string
}
```

### 现有 DropdownMenu 结构参考

```tsx
// 当前项目卡片 DropdownMenu（仅有"删除"）
<DropdownMenuContent align="end">
  <DropdownMenuItem
    className="text-destructive focus:text-destructive"
    onClick={(e) => {
      e.stopPropagation()
      setProjectToDelete(project)
      setDeleteDialogOpen(true)
    }}
  >
    <Trash2 className="mr-2 h-4 w-4" />
    删除
  </DropdownMenuItem>
</DropdownMenuContent>

// 目标：扩展为
<DropdownMenuContent align="end">
  <DropdownMenuItem onClick={/* 重命名 */}>
    <PenLine className="mr-2 h-4 w-4" />
    重命名
  </DropdownMenuItem>
  <DropdownMenuItem onClick={/* 编辑信息 */}>
    <FileEdit className="mr-2 h-4 w-4" />
    编辑信息
  </DropdownMenuItem>
  <DropdownMenuSeparator />
  <DropdownMenuItem className="text-destructive ...">
    <Trash2 className="mr-2 h-4 w-4" />
    删除
  </DropdownMenuItem>
</DropdownMenuContent>
```

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

- 修复智能引号 (U+201C/U+201D) 被误植入 JSX 属性的问题，使用 Node.js 脚本批量替换为 ASCII 引号

### Completion Notes List

- **Task 1 完成**: 新增项目重命名功能 — DropdownMenu 新增"重命名"菜单项 (PenLine 图标)，Dialog 弹窗带标题输入框，handleRenameProject() 函数复用 updateProject() Server Action，成功后乐观更新列表 + toast 通知，失败不关闭对话框
- **Task 2 完成**: 新增项目信息编辑功能 — DropdownMenu 新增"编辑信息"菜单项 (FileEdit 图标)，Dialog 弹窗含标题/简介/题材表单（预填当前数据），handleEditProject() 函数复用 updateProject()，成功后乐观更新所有字段 + toast 通知
- **Task 3 完成**: 确认已有创建/删除功能代码未被修改（回归安全），共享 loading state 防止并发操作，RLS 策略通过 Server Action 内的 user_id 校验持续生效
- **Task 4 完成**: lint 0 errors + build 通过；手动验证项（4.3-4.7）代码路径完整实现，需用户运行时确认
- **架构合规**: 仅修改 1 个文件，未引入新依赖，严格遵循现有 Server Action 调用模式和 shadcn/ui 组件模式
- **中文 UI**: 所有用户可见文本均为中文（对话框标题、描述、按钮文案、toast 通知）

### File List

- `writeteam/src/components/dashboard/dashboard-content.tsx` — 修改：新增 updateProject 导入、FileEdit 图标导入、重命名/编辑状态管理（6 个新 useState）、handleRenameProject/handleEditProject 处理函数、DropdownMenu 扩展（重命名+编辑信息+分隔线）、重命名 Dialog、编辑信息 Dialog

### Senior Developer Review (AI)

**Reviewer:** Elij (Claude Opus 4.6)
**Date:** 2026-02-28
**Outcome:** Approved (after fixes)

**Issues Found & Fixed (8 total):**
- [C1][CRITICAL] 修复：重命名/编辑操作的 toast.error 直接透传英文 Supabase 错误 → 改为中文提示（AC5 违规）
- [M1][MEDIUM] 修复：重命名/编辑对话框无 form 包裹，Enter 键无法提交 → 用 form onSubmit 包裹（NFR9 键盘可达）
- [M2][MEDIUM] 修复：DropdownMenu 操作项在 loading 状态下仍可点击 → 添加 disabled={loading}
- [M3][MEDIUM] 修复：重命名/编辑后项目列表未重排序 → 添加 .sort() 按 updated_at desc（AC1 违规）
- [M4][MEDIUM] 修复：编辑对话框题材 Select 无清除选项 → 添加"不设置题材"选项 + 值解析（AC3 完整性）
- [L1][LOW] 修复：GENRES 中文值调用 .toLowerCase() 无效 → 移除（代码气味）
- [L2][LOW] 修复：CardDescription className="capitalize" 对中文无效 → 移除
- [L3][LOW] 修复：编辑对话框关闭时未完全重置表单状态 → 补齐 editTitle/editDescription/editGenre 清除

**Verification:** lint 0 errors + build 通过

### Change Log

- 2026-02-28: Story 2-1 实现完成 — 新增项目重命名和编辑信息功能，补齐 Dashboard 项目管理 CRUD 闭环
- 2026-02-28: Code Review 完成 — 修复 8 个问题（1 Critical + 4 Medium + 3 Low），所有 AC 验证通过
