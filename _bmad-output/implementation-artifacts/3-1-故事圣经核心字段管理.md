# Story 3.1: 故事圣经核心字段管理

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 创作者用户,
I want 维护题材、主题、语气和规则等故事圣经字段,
so that AI 生成更贴合我的创作目标。

## Acceptance Criteria

1. **Given** 用户进入故事圣经面板，**When** 用户编辑并保存核心字段，**Then** 字段变更持久化并可被后续 AI 调用读取。
2. **And** 字段变更具备版本化感知或修改反馈以避免误覆盖（FR9）。

## Tasks / Subtasks

- [x] Task 1: 建立核心字段的读取与编辑闭环（AC: 1）
  - [x] 1.1 梳理并统一核心字段范围（题材、设定、主题、语气、AI 规则、可见性等）与前端表单映射。
  - [x] 1.2 在故事圣经面板中提供可编辑交互，保证中文文案和可读反馈。
  - [x] 1.3 加载已有字段值并回填到表单，避免首次进入覆盖旧数据。
- [x] Task 2: 完成安全持久化与并发保护（AC: 1, 2）
  - [x] 2.1 通过 Server Action 执行写入，强制 `supabase.auth.getUser()` 门禁和用户隔离。
  - [x] 2.2 更新后返回明确成功/失败状态，并在 UI 呈现“已保存/保存失败/冲突风险”反馈。
  - [x] 2.3 增加误覆盖保护：至少实现修改时间提示、脏状态提示或冲突提示中的一种。
- [x] Task 3: 确保 AI 上下文链路可消费最新字段（AC: 1）
  - [x] 3.1 校验 `fetchStoryContext -> buildStoryPromptContext` 能读取并使用最新故事圣经字段。
  - [x] 3.2 校验 `visibility` 对上下文注入的过滤行为保持正确。
  - [x] 3.3 保持 BYOK 机密边界，不在日志/遥测中输出敏感配置。
- [x] Task 4: 验证与回归（AC: all）
  - [x] 4.1 运行 `npm run lint` 与 `npm run build`。
  - [x] 4.2 手测保存成功、失败与重试路径，验证用户可继续编辑且反馈可执行。
  - [x] 4.3 手测 AI 调用前后故事圣经字段生效一致性。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 冲突后直接更新 `lastSavedAt` 会允许陈旧表单再次覆盖最新数据；应在冲突后强制刷新/重载或进入只读冲突态，避免误覆盖。 [`writeteam/src/components/story-bible/story-bible-panel.tsx`]
- [x] [AI-Review][HIGH] `updateStoryBible` 缺少更新字段白名单，且当前 RLS update policy 无 `WITH CHECK`；应限制可写字段并补齐策略，防止 `user_id/project_id` 等被篡改。 [`writeteam/src/app/actions/story-bible.ts`, `writeteam/supabase/migrations/011_story_bibles_update_policy_with_check.sql`]
- [x] [AI-Review][MEDIUM] 文档状态存在冲突：头部 `Status` 与 Story Completion Status 不一致；需统一状态来源避免流程误判。 [`_bmad-output/implementation-artifacts/3-1-故事圣经核心字段管理.md`]
- [x] [AI-Review][MEDIUM] 并发冲突路径缺少自动化测试；需补充 Story Bible 保存冲突场景测试以降低回归风险。 [`writeteam/src/app/actions/story-bible.test.ts`]

## Dev Notes

- 本故事是 Epic 3 第一个故事，决定后续 Story 3.2（角色资料）与 Story 3.3（可见性/系列共享）的字段语义与写入模式。
- 目标不是新增独立存储体系，而是在现有 `story_bibles` 和 AI 上下文编排链路上增强“可编辑 + 可感知 + 不误覆盖”。
- 必须遵守既有 BYOK 与鉴权边界：用户密钥不落库，业务数据由 RLS + `getUser()` 双保险。

### Project Structure Notes

- 预计主要变更文件（按现有架构优先级）：
  - `writeteam/src/components/story-bible/*`
  - `writeteam/src/app/actions/story-bible.ts`
  - `writeteam/src/lib/ai/story-context.ts`
  - `writeteam/src/types/database.ts`（仅在确有 schema 变化时）
- 不应引入新认证中间件文件；Next.js 16 继续使用 `src/proxy.ts` 约定。

### References

- [Source: `_bmad-output/planning-artifacts/epics.md`#Epic 3: 故事知识库与设定治理]
- [Source: `_bmad-output/planning-artifacts/epics.md`#Story 3.1: 故事圣经核心字段管理]
- [Source: `_bmad-output/planning-artifacts/prd.md`#FR9]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Data Architecture]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Authentication & Security]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Requirements to Structure Mapping]
- [Source: `_bmad-output/planning-artifacts/ux-design-specification.md`#失败恢复不断流（差异化关键路径）]
- [Source: `_bmad-output/project-context.md`#Critical Don't-Miss Rules]

## Developer Context Section

### Technical Requirements

- 核心字段写入必须落到现有故事圣经数据模型，保持 `content/content_text/word_count` 等既有文档规则不被破坏。
- API/Action 错误输出遵循现有模式：Route Handler 用 `Response.json({ error }, { status })`，Server Action 返回 `{ error }` 或 `{ data }`。
- 用户可见反馈必须中文，且错误反馈必须给出可执行下一步（重试、检查字段、稍后再试）。

### Architecture Compliance

- 严格遵守固定 AI 链路：`auth -> resolveAIConfig -> fetchStoryContext -> buildStoryPromptContext -> createOpenAIStreamResponse`。
- 所有写操作通过服务端门禁；不得在客户端直接进行越权写入。
- 保持目录边界：UI 在 `components/story-bible`，数据写入在 `app/actions/story-bible.ts`，AI 上下文逻辑在 `lib/ai/*`。

### Library / Framework Requirements

- Next.js 16：使用 `proxy.ts` 约定，不新增 `middleware.ts`。
- Supabase SSR：服务端客户端创建遵循 `@supabase/ssr` 官方 cookie 模式；在服务端路径通过 `getUser()` 做真实鉴权。
- TipTap 相关（若联动编辑器状态提示）：避免不必要重渲染，优先使用精细状态订阅与防抖更新策略。

### File Structure Requirements

- 新增/修改文件使用 kebab-case，保持 `src/components/story-bible/` 与 `src/app/actions/story-bible.ts` 作为首选落点。
- 若新增数据库字段，必须追加 migration 并同步更新 `writeteam/src/types/database.ts`，禁止破坏式修改。

### Testing Requirements

- 必做：`npm run lint`、`npm run build`。
- 手测最小集合：
  - 字段编辑保存成功与失败反馈
  - 刷新后字段回显
  - AI 生成链路读取更新后字段
  - 并发/误覆盖防护提示

## Latest Tech Information

- Next.js 16 已将 `middleware` 文件约定迁移为 `proxy`，官方升级指南要求使用 `proxy.ts` 与 `export function proxy()`。
- Supabase SSR 官方建议在服务端使用 `createServerClient` 并显式提供 cookie 读写接口，保证会话刷新行为正确。
- TipTap React 性能指南建议：通过 `useEditorState` 订阅最小必要状态，必要时关闭按 transaction 全量重渲染。

## Project Context Reference

- [Source: `_bmad-output/project-context.md`#Technology Stack & Versions]
- [Source: `_bmad-output/project-context.md`#Framework-Specific Rules (Next.js 16 / React 19)]
- [Source: `_bmad-output/project-context.md`#Critical Don't-Miss Rules]

## Story Completion Status

- Story status 已设置为：`done`
- Completion note：Code review follow-ups resolved; high/medium findings fixed and re-verified

## Dev Agent Record

### Agent Model Used

gpt-5.3-codex

### Debug Log References

- create-story workflow: 已读取 `workflow.yaml`、`instructions.xml`、`template.md`、`checklist.md`。
- create-story workflow: 已从 `sprint-status.yaml` 自动选择首个 backlog 故事 `3-1-故事圣经核心字段管理`。
- create-story workflow: 已分析 `epics.md`、`prd.md`、`architecture.md`、`ux-design-specification.md`、`project-context.md`。
- create-story workflow: 已根据步骤更新 `sprint-status.yaml`（`epic-3` -> `in-progress`，故事 -> `ready-for-dev`）。
- dev-story: 使用提供的 DeepSeek 测试 key 对 `https://api.deepseek.com/chat/completions` 进行实连验证，返回 `200` 且有有效 completion。
- dev-story: 本地路由 `POST /api/ai/test-connection` 在携带 `X-AI-*` 头时返回 `{"error":"未登录"}`，鉴权门禁生效。

### Completion Notes List

- 已完成：自动发现目标故事并解析 story id/key/title。
- 已完成：提取 Epic 3 全量上下文与 Story 3.1 验收标准。
- 已完成：提炼架构、鉴权、安全、目录边界与测试守护栏。
- 已完成：补充 Next.js 16 / Supabase SSR / TipTap 的最新实现要点。
- 已完成：在 `updateStoryBible` 增加基于 `updated_at` 的并发版本冲突检测，避免误覆盖。
- 已完成：故事圣经面板增加“未保存更改/上次保存时间”反馈，保存成功后更新时间并清除脏状态。
- 已完成：保存时传递 `expectedUpdatedAt`，当检测冲突时返回可执行中文提示。
- 已验证：`lsp_diagnostics`（story-bible action/panel）0 diagnostics。
- 已验证：`npm run lint`、`npm run build` 通过（存在 2 个既有 lint warning，位于 visualize-panel，与本故事无关）。
- 待完成：手测保存/重试路径与 AI 上下文生效一致性（需登录态与可用项目数据）。
- 已确认：外部模型连通正常；剩余待办仅为登录态下 UI/业务路径手测。
- 已完成登录态手测（账号由用户提供）：
  - 保存成功路径：同页保存出现“故事圣经已保存”提示。
  - 并发冲突路径：双标签页并发写入，旧页保存出现“保存失败：检测到他处已更新故事圣经，请刷新后重试。”。
  - AI 生效链路：同一项目先清空 AI 规则再调用 `/api/ai/chat` 得到“你好。”；随后写入强约束规则后再次调用，返回包含测试标记，证明 `fetchStoryContext -> buildStoryPromptContext` 使用了最新故事圣经字段。
  - 已将 AI 规则测试值恢复为空，避免污染项目内容。

### File List

- `_bmad-output/implementation-artifacts/3-1-故事圣经核心字段管理.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `writeteam/src/app/actions/story-bible.ts`
- `writeteam/src/app/actions/story-bible-guards.ts`
- `writeteam/src/app/actions/story-bible.test.ts`
- `writeteam/src/components/story-bible/story-bible-panel.tsx`
- `writeteam/supabase/migrations/011_story_bibles_update_policy_with_check.sql`
- `writeteam/package.json`
- `writeteam/package-lock.json`

### Senior Developer Review (AI)

- Reviewer: Elij
- Date: 2026-02-28
- Outcome: Approved
- Summary: 已完成并发冲突防误覆盖、写入字段白名单与 RLS WITH CHECK 加固，并补齐关键并发判定自动化测试，满足推进 done 条件。
- Findings:
  - [HIGH] 并发冲突后 UI 直接更新 `lastSavedAt`，允许陈旧内容二次覆盖。
  - [HIGH] `updateStoryBible` 更新字段未做白名单约束，叠加 RLS policy 形态存在完整性风险。
  - [MEDIUM] 文档内部状态字段不一致，影响流程追踪准确性。
  - [MEDIUM] 缺少并发冲突自动化测试，回归风险未被持续验证。

### Change Log

- 2026-02-28: Story 3.1 开发进行中。已完成核心字段持久化并发防误覆盖（版本冲突检测）与保存状态反馈增强；完成 lint/build 与 LSP 校验，待补充登录态手测后进入 review。
- 2026-02-28: 完成登录态端到端验证（保存成功、并发冲突、AI 上下文生效），故事状态推进为 `review`。
- 2026-02-28: 完成 code-review，判定为 Changes Requested；新增 `Review Follow-ups (AI)`（2 High + 2 Medium），故事状态回置为 `in-progress`。
- 2026-02-28: 已自动修复 code-review 全部 High/Medium 问题，补充测试与安全策略，故事状态更新为 `done`。
- 2026-02-28: 完成回归验证：`npm --prefix writeteam run test && npm --prefix writeteam run lint && npm --prefix writeteam run build`；test 通过、build 通过，lint 仅存在既有 `visualize-panel.tsx` 两条 no-img 警告。
