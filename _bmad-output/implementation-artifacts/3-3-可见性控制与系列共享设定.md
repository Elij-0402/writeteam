# Story 3.3: 可见性控制与系列共享设定

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 创作者用户,
I want 控制设定可见性并在系列中共享核心设定,
so that 多项目创作时保持世界观一致且可控。

## Acceptance Criteria

1. **Given** 用户维护项目与系列层设定，**When** 用户设置可见性并关联到指定项目，**Then** AI 仅使用被允许的设定数据。
2. **And** 系列共享设定可被关联项目继承且权限边界不被突破（FR11, FR12, NFR6）。

## Tasks / Subtasks

- [x] Task 1: 落地可见性字段治理并保证权限边界（AC: 1, 2）
  - [x] 1.1 在故事圣经更新链路中严格白名单化 `visibility` 字段（仅允许预期键），拒绝未知键并返回可执行中文提示。
  - [x] 1.2 在服务端操作中统一执行 `supabase.auth.getUser()` 门禁，并确保 `.eq("user_id", user.id)` 约束覆盖可见性相关读写路径。
  - [x] 1.3 对可见性数据增加最小结构校验（布尔值语义、缺省值回退），避免脏数据导致 AI 注入越界。
- [x] Task 2: 完成系列共享设定继承策略（AC: 2）
  - [x] 2.1 明确并实现“项目优先、系列兜底”的字段合并策略（genre/style/themes/setting/worldbuilding/notes）。
  - [x] 2.2 在 `fetchStoryContext` 中保持 series fallback 仅在项目字段为空时生效，避免覆盖项目显式设定。
  - [x] 2.3 校验 `projects.series_id` 关联/解绑路径与 `series_bibles` 读写路径一致，保证跨项目共享可用但不越权。
- [x] Task 3: 强化 AI 上下文过滤与可解释反馈（AC: 1）
  - [x] 3.1 在 `buildStoryPromptContext` 中确保每个上下文字段均经过可见性开关判定，默认安全回退行为明确。
  - [x] 3.2 对“角色上下文不可见/缺失/冲突”保持可解释提示，不允许静默失败或注入非授权数据。
  - [x] 3.3 校验 writing/planning/check/chat 特性分组下的注入行为一致，避免不同工具出现权限漂移。
- [x] Task 4: 测试与回归（AC: all）
  - [x] 4.1 补充/更新 `story-context` 与 `series` 相关单元测试（可见性开关、系列兜底、权限边界）。
  - [x] 4.2 增加至少 1 条“越权不可见字段不被注入”负向断言，防止回归。
  - [x] 4.3 运行 `npm run lint` 与 `npm run build`，并记录验证结果。

### Review Follow-ups (AI)

- [x] [AI-Review][High] 为 `updateSeries` 引入字段白名单，禁止透传 `user_id` / `id` 等敏感字段，避免越权写入风险。 [`writeteam/src/app/actions/series.ts:98`]
- [x] [AI-Review][High] 修复 `updateSeriesBible` 插入路径字段覆盖顺序，禁止 `...updates` 覆盖 `series_id` 与 `user_id`。 [`writeteam/src/app/actions/series.ts:268`]
- [x] [AI-Review][Medium] 在 `fetchStoryContext` 查询链路中补充显式 `user_id` 过滤（调用方统一传入 userId），消除实现与任务 1.2 的声明偏差。 [`writeteam/src/lib/ai/story-context.ts:166`]
- [x] [AI-Review][Medium] 明确“项目优先、系列兜底”空值语义：仅在项目字段为 `null/undefined` 时触发兜底，保留空字符串显式值。 [`writeteam/src/lib/ai/story-context.ts:225`]
- [x] [AI-Review][Medium] 调整 `visibility` 更新逻辑：区分 `undefined` 与 `null`，避免显式 `undefined` 导致可见性被清空。 [`writeteam/src/app/actions/story-bible.ts:44`]
- [x] [AI-Review][Low] 增加攻击性测试：恶意 `updates` 覆盖敏感字段、空字符串优先级分支。 [`writeteam/src/app/actions/series.test.ts:152`]

## Dev Notes

- 本故事是 Epic 3 的第三个故事，目标是把“信息可见性控制”和“系列共享继承”做成 AI 上下文链路中的硬约束，而不是 UI 层软约定。
- 已有实现基础：
  - `story_bibles.visibility` 已存在并在 `buildStoryPromptContext` 使用。
  - `projects.series_id` 与 `series_bibles` 已存在，`fetchStoryContext` 已有系列兜底逻辑。
- 本故事重点不是新增大而全的数据模型，而是补齐守护栏：输入校验、权限边界、注入一致性、失败可解释。

### Project Structure Notes

- 主要改动优先聚焦以下文件：
  - `writeteam/src/lib/ai/story-context.ts`
  - `writeteam/src/lib/ai/story-context.test.ts`
  - `writeteam/src/app/actions/story-bible.ts`
  - `writeteam/src/app/actions/story-bible-guards.ts`
  - `writeteam/src/app/actions/series.ts`
  - `writeteam/src/types/database.ts`（仅在 schema 变化时）
- 延续 Next.js 16 约定：不得新增 `middleware.ts`，认证保护继续使用 `src/proxy.ts`。

### References

- [Source: `_bmad-output/planning-artifacts/epics.md`#Epic 3: 故事知识库与设定治理]
- [Source: `_bmad-output/planning-artifacts/epics.md`#Story 3.3: 可见性控制与系列共享设定]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Data Architecture]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Authentication & Security]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#API & Communication Patterns]
- [Source: `_bmad-output/planning-artifacts/ux-design-specification.md`#失败恢复不断流（差异化关键路径）]
- [Source: `_bmad-output/project-context.md`#Critical Don't-Miss Rules]

## Developer Context Section

### Technical Requirements

- 可见性控制必须在服务端生效，不能仅依赖前端过滤。
- AI 注入链路必须对每个上下文字段执行显式可见性判定（含 characters）。
- 系列共享设定采用“项目值优先，系列值兜底”策略，不允许反向覆盖。
- 错误提示必须可执行（例如“补全字段/修改可见性/刷新重试”），禁止“只报错不指路”。

### Architecture Compliance

- 严格遵循 AI 固定链路：`auth -> resolveAIConfig -> fetchStoryContext -> buildStoryPromptContext -> createOpenAIStreamResponse`。
- 所有 Server Actions 与 Route Handlers 均需 `supabase.auth.getUser()` 门禁。
- 数据访问继续遵循 RLS 与 `user_id = auth.uid()` 边界，不引入绕过路径。

### Library / Framework Requirements

- Next.js 16：保持 `proxy.ts` 会话保护约定，不回退过时中间件模式。
- Supabase：维持 RLS 策略完整性，敏感表策略需覆盖 select/insert/update/delete 的边界语义。
- TypeScript strict：可见性对象需显式类型约束，避免宽泛 `Record<string, unknown>` 直接透传。

### File Structure Requirements

- 可见性与上下文拼装逻辑放在 `lib/ai/story-context.ts` 与 guard 层，不在 UI 组件内散落权限判断。
- 系列关联与系列圣经维护保持在 `app/actions/series.ts`，避免跨文件重复实现。
- 若新增 migration，需追加 SQL 文件并同步 `src/types/database.ts`。

### Testing Requirements

- 必测范围：
  - `visibility` 开关对各上下文字段注入行为的影响（含默认值）。
  - 系列兜底合并策略（项目有值/无值两类分支）。
  - 用户隔离与越权防护（不可见字段不注入、非所属数据不可改）。
- 回归命令：`npm run lint`、`npm run build`。

## Previous Story Intelligence

- 来自 3.2 的关键经验：
  - 冲突和异常不能静默，必须转成用户可执行提示。
  - 变更字段必须白名单化，防止宽泛更新造成越权或污染。
  - 角色与故事圣经上下文注入要有负向断言，避免“声明支持但实际漏测”。
  - 文档状态与冲刺状态需要一致更新，避免流程误判。

## Git Intelligence Summary

- 最近提交显示 Epic 3 已建立“并发保护 + 字段白名单 + 角色冲突治理 + 测试补齐”模式；3.3 应复用该模式到可见性与系列继承场景。
- `story-context.ts` 与 `story-bible-guards.ts` 已是上下文注入与字段治理核心落点，优先在现有路径增强，避免新建并行实现。
- 最近工作流产物持续同步 `implementation-artifacts` 与 `sprint-status.yaml`，本故事需保持同样交付节奏。

## Latest Tech Information

- Next.js 16 认证与授权建议在服务端执行，并在 App Router 下通过 `proxy.ts` 保护路由入口；不要依赖仅客户端检查。  
  Source: https://nextjs.org/docs/app/api-reference/file-conventions/proxy
- Next.js 官方认证指南强调服务端鉴权（Server Components/Actions/Route Handlers）和会话边界一致性。  
  Source: https://github.com/vercel/next.js/blob/canary/docs/01-app/02-guides/authentication.mdx
- Supabase RLS 最佳实践：策略中使用 `auth.uid()` 边界校验，避免把访问控制只留在应用层。  
  Source: https://supabase.com/docs/guides/troubleshooting/rls-simplified-BJTcS8
- Supabase 建议在策略中使用显式约束与最小权限原则，确保多租户隔离在数据库层强制执行。  
  Source: https://makerkit.dev/blog/tutorials/supabase-rls-best-practices

## Project Context Reference

- [Source: `_bmad-output/project-context.md`#Framework-Specific Rules (Next.js 16 / React 19)]
- [Source: `_bmad-output/project-context.md`#BYOK 数据流]
- [Source: `_bmad-output/project-context.md`#Security Rules]

## Story Completion Status

- Story status 已设置为：`done`
- Completion note：Code review 发现的问题已全部修复并通过 test/lint/build 验证。

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

- create-story: 已读取 `workflow.yaml`、`instructions.xml`、`template.md`、`checklist.md`。
- create-story: 已从 `sprint-status.yaml` 自动定位首个 backlog 故事 `3-3-可见性控制与系列共享设定`。
- create-story: 已分析 `epics.md`、`architecture.md`、`prd.md`、`ux-design-specification.md`、`project-context.md`、上一故事文档与最近提交。
- create-story: 已补充 Next.js 16 / Supabase RLS 最新守护信息。

### Completion Notes List

- 已完成：在 `story-bible-guards` 增加 `validateVisibilityUpdate`，严格校验 visibility 键白名单、布尔值语义与默认值回退，并输出可执行中文报错。
- 已完成：`updateStoryBible` 接入 visibility 校验，拒绝未知字段与非法值，避免脏数据注入 AI 上下文。
- 已完成：`fetchStoryContext` 增强系列继承策略，支持项目圣经缺失时的系列兜底；项目有值时保持项目优先。
- 已完成：`buildStoryPromptContext` 对角色可见性关闭场景输出可解释提示，避免静默失败。
- 已完成：`series` Actions 增加系列归属校验，阻断越权关联与越权读写 `series_bibles`。
- 已完成：补齐并通过 `story-context` / `story-bible` / `series` 测试，新增负向断言覆盖越权不可见字段不注入。
- 验证结果：`npm run test` 28/28 通过；`npm run build` 通过；`npm run lint` 0 error（存在 2 条既有 no-img warning，未影响本故事）。

### File List

- `_bmad-output/implementation-artifacts/3-3-可见性控制与系列共享设定.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `writeteam/src/app/actions/story-bible-guards.ts`
- `writeteam/src/app/actions/story-bible.ts`
- `writeteam/src/app/actions/series.ts`
- `writeteam/src/app/actions/story-bible.test.ts`
- `writeteam/src/app/actions/series.test.ts`
- `writeteam/src/lib/ai/story-context.ts`
- `writeteam/src/lib/ai/story-context.test.ts`
- `writeteam/package.json`

## Change Log

- 2026-02-28: 完成可见性字段治理、系列共享继承守护与上下文注入一致性修复；补齐单测与回归验证，故事状态切换为 `review`。
- 2026-02-28: Senior Developer Review (AI) 完成，对抗审查发现 2 个 High、3 个 Medium、1 个 Low 问题；已新增 Review Follow-ups 并将故事状态回退为 `in-progress`。
- 2026-02-28: 修复全部 Review Follow-ups（含安全白名单、用户边界、空值语义与回归测试），故事状态更新为 `done`。

## Senior Developer Review (AI)

- Reviewer: Hephaestus (AI)
- Date: 2026-02-28
- Outcome: Changes Requested
- Summary: 核心功能已覆盖可见性控制与系列兜底主路径，但仍存在越权透传与边界语义不一致问题，未满足“可审计的权限边界闭环”。

### Findings

1. **[High] `series` 更新链路缺少字段白名单，存在敏感字段透传风险**  
   `updateSeries` 与 `updateSeriesBible` 直接展开 `...updates` 写库，应用层未阻断 `user_id` / `series_id` 等敏感字段。  
   Evidence: `writeteam/src/app/actions/series.ts:98`, `writeteam/src/app/actions/series.ts:260`, `writeteam/src/types/database.ts:415`

2. **[High] `updateSeriesBible` 插入路径存在字段覆盖顺序漏洞**  
   对象字面量中 `...updates` 位于 `{ series_id, user_id }` 之后，调用方可覆盖可信字段。  
   Evidence: `writeteam/src/app/actions/series.ts:268`

3. **[Medium] `fetchStoryContext` 未显式附加 `user_id` 过滤，与任务 1.2 声明不一致**  
   当前实现依赖 RLS，缺少应用层显式边界表达，不利于审计与防回归。  
   Evidence: `writeteam/src/lib/ai/story-context.ts:166`, `writeteam/src/lib/ai/story-context.ts:195`

4. **[Medium] 系列兜底合并使用 truthy 语义，可能覆盖项目显式空值**  
   项目字段若为空字符串，当前会被视为“无值”并被系列值覆盖，存在策略歧义。  
   Evidence: `writeteam/src/lib/ai/story-context.ts:225`

5. **[Medium] `visibility` 传入 `undefined` 时可能被归一为 `null` 并清空配置**  
   `"visibility" in sanitizedUpdates` + `value == null` 组合会把显式 undefined 视作 null 路径。  
   Evidence: `writeteam/src/app/actions/story-bible.ts:44`, `writeteam/src/app/actions/story-bible-guards.ts:81`

6. **[Low] 测试未覆盖关键攻击路径与空字符串语义分支**  
   当前测试覆盖 ownership gate，但未覆盖恶意 payload 覆盖敏感字段与空字符串优先级。  
   Evidence: `writeteam/src/app/actions/series.test.ts:139`, `writeteam/src/lib/ai/story-context.test.ts:266`
