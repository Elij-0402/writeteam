# Story 4.1: 上下文写作能力（续写/改写/扩写/缩写）

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 创作者用户,
I want 在当前文档上下文中直接调用核心写作能力,
so that 我能快速推进章节内容。

## Acceptance Criteria

1. **Given** 用户在编辑器中定位光标（无选区），**When** 用户触发"续写"，**Then** 系统基于故事上下文和光标前文本流式返回续写结果，用户可一键插入到光标位置。
2. **Given** 用户在编辑器中选中一段文本，**When** 用户触发"改写"并选择模式（rephrase/shorter/longer/show-not-tell/more-intense/more-lyrical/custom），**Then** 系统返回改写后文本，用户可替换选区或插入到选区后。
3. **Given** 用户选中文本或光标位于段落尾部，**When** 用户触发"扩写"，**Then** 系统返回 2-3 倍长度的扩写结果，增加细节、感官描写和内心独白。
4. **Given** 用户选中一段文本，**When** 用户触发"缩写"，**Then** 系统返回约 50% 长度的精简结果，保留核心含义和风格。
5. **Given** 任意一次 AI 调用，**When** 首字返回时间超过 3 秒或流式中断，**Then** 系统展示恢复操作栏（重试/切换模型/保留上下文继续），不丢失已生成内容（FR13, NFR2, NFR8）。
6. **Given** 用户在 AI 工具栏或浮动选区菜单中触发写作能力，**When** 结果流式返回完成，**Then** 用户可通过"插入编辑器"/"替换选区"/"复制"三种方式处理结果，且操作后编辑器 1 秒内自动保存。
7. **Given** 故事圣经已配置 prose_mode（如 cinematic/lyrical/minimal），**When** 用户调用任意写作能力，**Then** 生成文本风格与所选散文模式一致；用户也可在调用时临时覆盖风格。

## Tasks / Subtasks

- [x] Task 1: 验证并修复续写（write）端到端流程（AC: 1, 5, 6, 7）
  - [x] 1.1 验证 `/api/ai/write` 路由在 auto/guided/tone-* 全部 6 种模式下能正确返回流式结果
  - [x] 1.2 验证 `AIToolbar` 续写按钮 → 模式选择 → 生成 → 结果展示 → 插入编辑器全链路
  - [x] 1.3 验证 prose mode 覆盖生效：Story Bible 风格 vs 调用时临时覆盖
  - [x] 1.4 验证 saliency 信息（当前活跃角色/地点）被传入 write 调用上下文
  - [x] 1.5 修复发现的任何集成问题并确保 TipTap 正确在光标位置插入文本
- [x] Task 2: 验证并修复改写（rewrite）端到端流程（AC: 2, 5, 6）
  - [x] 2.1 验证 `/api/ai/rewrite` 在 rephrase/shorter/longer/show-not-tell/more-intense/more-lyrical/custom 全部 7 种模式下返回正确结果
  - [x] 2.2 验证 `AIToolbar` 改写按钮：选区 → 模式选择 → 自定义指令（custom 模式）→ 结果 → 替换/插入
  - [x] 2.3 验证 `SelectionAIMenu` 浮动菜单改写：选区 → 一键改写（rephrase）→ 替换/插入
  - [x] 2.4 验证替换操作正确删除原选区并插入新文本，不影响选区外内容
  - [x] 2.5 确保无选区时改写按钮不可用（graceful disable + 提示）
- [x] Task 3: 验证并修复扩写（expand）端到端流程（AC: 3, 5, 6）
  - [x] 3.1 验证 `/api/ai/expand` 在有选区和无选区（取最后 2000 字符）两种场景下均正确返回
  - [x] 3.2 验证扩写结果长度约为原文 2-3 倍，包含细节增强
  - [x] 3.3 验证 `AIToolbar` 和 `SelectionAIMenu` 两个入口的扩写流程完整
  - [x] 3.4 验证扩写结果插入后编辑器状态一致（word count 更新、autosave 触发）
- [x] Task 4: 验证并修复缩写（shrink）端到端流程（AC: 4, 5, 6）
  - [x] 4.1 验证 `/api/ai/shrink` 返回约 50% 长度的精简结果
  - [x] 4.2 验证缩写必须有选区（无选区时按钮 disable + 提示）
  - [x] 4.3 验证 `AIToolbar` 和 `SelectionAIMenu` 两个入口的缩写流程
  - [x] 4.4 验证替换后 word count 减少且 autosave 正常触发
- [x] Task 5: 错误恢复与超时处理（AC: 5）
  - [x] 5.1 验证 AI 调用超时（TTFB > 3s）时 UI 展示恢复操作栏
  - [x] 5.2 验证网络错误、401（未认证）、400（AI 未配置）时的错误提示清晰且可执行
  - [x] 5.3 验证重试按钮复用原始参数重新调用
  - [x] 5.4 验证流式中断时已接收的部分结果不丢失，用户可查看/复制已生成内容
  - [x] 5.5 验证错误遥测被写入 `ai_history` 表（failure_type, recovery_type）
- [x] Task 6: 单元测试与回归验证（AC: all）
  - [x] 6.1 为 4 个 AI 路由的核心逻辑添加 Vitest 单元测试（mock Supabase + mock stream）
  - [x] 6.2 为 `buildStoryPromptContext` 的 write/rewrite/expand/shrink feature 分支添加测试
  - [x] 6.3 验证 prose mode 覆盖逻辑在 story-context 层的正确性
  - [x] 6.4 运行 `npm run lint` + `npm run build` + `npm run test` 确保全部通过

## Dev Notes

- **关键发现：本故事约 70% 已实现**。后端 API 路由（write/rewrite/expand/shrink）、AI 上下文编排、流式管道、AI 工具栏和浮动选区菜单均已存在。开发者的核心任务是**验证、修复和补测**，而非从零构建。
- 已有 4 个完整的 AI 路由处理器，遵循标准链路：auth → resolveAIConfig → fetchStoryContext → buildStoryPromptContext → createOpenAIStreamResponse。
- `AIToolbar`（`src/components/ai/ai-toolbar.tsx`）已包含续写/改写/扩写/缩写按钮，带模式选择 Popover 和结果展示。
- `SelectionAIMenu`（`src/components/editor/selection-ai-menu.tsx`）已包含改写/扩写/缩写浮动菜单按钮。
- 续写（write）仅在工具栏中可用（不在选区菜单中），这是正确设计——续写基于光标位置而非选区。
- **重点关注区域**：
  1. 结果插入后 TipTap 编辑器状态同步（word count、autosave、content_text mirror）
  2. 错误恢复 UX 的完整性（重试、切换模型、上下文保留）
  3. TTFB 性能是否满足 P95 <= 3s 阈值
  4. 各模式的 AI 输出质量验证

### Project Structure Notes

- **不需要新建文件**——所有路由和组件已存在，本故事主要是验证和修复。
- **可能需要修改的文件**（按优先级排序）：
  - `writeteam/src/components/ai/ai-toolbar.tsx` — AI 工具栏交互与结果处理
  - `writeteam/src/components/editor/selection-ai-menu.tsx` — 浮动选区菜单
  - `writeteam/src/components/editor/writing-editor.tsx` — TipTap 编辑器实例（结果插入）
  - `writeteam/src/components/editor/editor-shell.tsx` — 编辑器容器（状态传递）
  - `writeteam/src/app/api/ai/write/route.ts` — 续写路由（如需修复）
  - `writeteam/src/app/api/ai/rewrite/route.ts` — 改写路由
  - `writeteam/src/app/api/ai/expand/route.ts` — 扩写路由
  - `writeteam/src/app/api/ai/shrink/route.ts` — 缩写路由
- **绝对不需要新建的**：
  - 不需要新的数据库 migration
  - 不需要新的 lib/ 文件（story-context、openai-stream、prose-mode 均已完善）
  - 不需要新的 Server Actions
- 延续 Next.js 16 约定：不得新增 `middleware.ts`

### References

- [Source: `_bmad-output/planning-artifacts/epics.md`#Epic 4: AI 写作与改写主流程]
- [Source: `_bmad-output/planning-artifacts/epics.md`#Story 4.1: 上下文写作能力（续写/改写/扩写/缩写）]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#API & Communication Patterns — AI pipeline contract]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Implementation Patterns & Consistency Rules]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Frontend Architecture]
- [Source: `_bmad-output/planning-artifacts/prd.md`#FR13 — 上下文驱动续写/改写/扩写/缩写]
- [Source: `_bmad-output/planning-artifacts/prd.md`#NFR2 — TTFB P95 <= 3s]
- [Source: `_bmad-output/planning-artifacts/prd.md`#NFR8 — AI 故障场景下核心写作链路可用性 >= 99.0%]
- [Source: `_bmad-output/planning-artifacts/ux-design-specification.md`#AI 生成并采纳 — 关键用户旅程]
- [Source: `_bmad-output/planning-artifacts/ux-design-specification.md`#失败恢复不断流 — 差异化关键路径]
- [Source: `_bmad-output/project-context.md`#AI API Route 固定模式]
- [Source: `_bmad-output/project-context.md`#Performance Gotchas]

## Developer Context Section

### Technical Requirements

- 全部 4 个写作能力（write/rewrite/expand/shrink）必须遵循已有 AI 固定链路：`auth → resolveAIConfig → fetchStoryContext → buildStoryPromptContext → createOpenAIStreamResponse`。
- 结果插入必须同时更新 TipTap JSON content + content_text 纯文本镜像 + word_count，三者同步由 autosave 链路保证。
- BYOK 密钥不得在任何日志或遥测中出现明文。
- 流式响应必须实时展示中间结果，不能等待完整响应再显示。
- 错误分类和恢复动作必须完整：network → 重试, auth → 重新登录, rate_limit → 切换模型, timeout → 重试+切换。

### Architecture Compliance

- **AI 路由模式**（已实现，验证即可）：
  ```typescript
  // 1. Auth
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return Response.json({ error: "未登录" }, { status: 401 })
  // 2. BYOK
  const aiConfig = resolveAIConfig(request)
  if (!aiConfig) return Response.json({ error: "未配置AI" }, { status: 400 })
  // 3. Context
  const storyContext = await fetchStoryContext(supabase, projectId, user.id)
  const promptContext = buildStoryPromptContext(storyContext, { feature, proseMode, saliencyMap })
  // 4. Stream
  return createOpenAIStreamResponse({ messages, ...aiConfig }, { supabase, userId: user.id, ... })
  ```
- **错误信封**：非流式返回 JSON `{ error: "..." }` + HTTP status code；流式成功返回 `text/plain` chunked stream。
- **状态管理**：AI 配置通过 `useAIConfig().getHeaders()` 获取，不在组件中硬编码 header 构造。
- **数据边界**：所有 Supabase 查询自动通过 RLS 过滤用户数据。

### Library / Framework Requirements

- **Next.js 16.1.6**：使用 `proxy.ts` 而非 `middleware.ts`。Route Handlers 在 `src/app/api/ai/*/route.ts`。
- **TipTap ^3.20.0**：
  - 插入内容使用 `editor.chain().focus().insertContent(text).run()` 或 `editor.chain().focus().deleteRange({from, to}).insertContentAt(from, text).run()`（替换选区）。
  - 监听 `onUpdate` 事件触发 autosave。
  - `CharacterCount` 扩展自动追踪 word count。
- **Supabase ^2.97.0**：`createClient()` 从 `@/lib/supabase/server` 导入（Route Handler 中），从 `@/lib/supabase/client` 导入（Client Component 中）。
- **Vitest ^3.2.4**：已安装，测试文件与源文件同目录 `*.test.ts`。

### File Structure Requirements

**已存在的关键文件（不要重建）：**

| 文件 | 职责 | 状态 |
|------|------|------|
| `src/app/api/ai/write/route.ts` | 续写路由：6 种模式，temp 0.8 | 已完成 |
| `src/app/api/ai/rewrite/route.ts` | 改写路由：7 种模式，temp 0.7 | 已完成 |
| `src/app/api/ai/expand/route.ts` | 扩写路由：2-3x 长度，temp 0.8 | 已完成 |
| `src/app/api/ai/shrink/route.ts` | 缩写路由：50% 长度，temp 0.5 | 已完成 |
| `src/lib/ai/story-context.ts` | 上下文编排（bible + characters + visibility + saliency） | 已完成 |
| `src/lib/ai/openai-stream.ts` | OpenAI 流式传输 + 遥测 + 错误分类 | 已完成 |
| `src/lib/ai/resolve-config.ts` | BYOK 配置提取（X-AI-* headers） | 已完成 |
| `src/lib/ai/prose-mode.ts` | 5 种散文风格引导 | 已完成 |
| `src/components/ai/ai-toolbar.tsx` | AI 工具栏：全部 4 种写作能力入口 | 已完成 |
| `src/components/editor/selection-ai-menu.tsx` | 浮动选区菜单：改写/扩写/缩写 | 已完成 |
| `src/components/editor/writing-editor.tsx` | TipTap 编辑器实例 | 已完成 |
| `src/components/editor/editor-shell.tsx` | 编辑器容器（状态传递、saliency 计算） | 已完成 |

**数据流图：**
```
用户操作 → AIToolbar / SelectionAIMenu
  ↓
fetch("/api/ai/{write|rewrite|expand|shrink}", { headers: getHeaders(), body })
  ↓
Route Handler: auth → resolveAIConfig → fetchStoryContext → buildStoryPromptContext → createOpenAIStreamResponse
  ↓
SSE Stream → readAIStream() → setResult(chunk) → UI 实时更新
  ↓
用户选择：插入 / 替换 / 复制
  ↓
TipTap editor.chain().insertContent() 或 deleteRange().insertContentAt()
  ↓
onUpdate → autosave (1s debounce) → Supabase DB
```

### Testing Requirements

- **单元测试（Vitest）**：
  - 为 4 个路由的参数验证逻辑编写测试（mock Supabase client + mock fetch）
  - 为 `buildStoryPromptContext` 在 feature = "write"/"rewrite"/"expand"/"shrink" 下的输出差异编写测试
  - 为 prose mode 覆盖逻辑（Story Bible 值 vs 调用时覆盖）编写测试
- **集成测试（手动）**：
  - 续写：光标定位 → 续写 → 插入 → autosave → 验证 DB 更新
  - 改写：选区 → 浮动菜单改写 → 替换 → autosave → 验证 word count 变化
  - 扩写：选区 → 扩写 → 插入 → 验证长度增加
  - 缩写：选区 → 缩写 → 替换 → 验证长度减少
  - 错误恢复：断开 AI 配置 → 触发任意写作能力 → 验证错误提示和恢复选项
- **回归命令**：`npm run lint` + `npm run build` + `npm run test`

## Previous Story Intelligence

- 来自 Story 3-3 的关键经验：
  - **字段白名单是硬约束**：所有写操作必须通过白名单校验，防止透传敏感字段。
  - **错误必须可执行**：返回中文提示 + 下一步动作，禁止静默失败。
  - **visibility 控制在服务端强制执行**：AI 上下文构建中每个字段都经过显式可见性判定。
  - **测试需要负向断言**：不仅测"功能正常"，还要测"非授权操作被拒绝"。
- 来自 Story 3-2 的关键经验：
  - **冲突检测模式**：使用 `updated_at` 时间戳防止并发覆盖。
  - **角色上下文注入已完善**：角色 visibility toggle 控制注入，max 15 characters per AI call。
  - **代码模式**：输入验证 → 字段白名单 → 用户门禁 → 返回状态 + 可执行反馈。
- 跨故事一致模式：
  - 三层安全模型：Input Validation → Field Whitelist → RLS + User Boundary
  - 特性感知上下文：write/planning/check/chat 获得不同上下文子集
  - 测试基线：Auth/isolation tests + conflict tests + lint/build gates

## Git Intelligence Summary

- 最近 5 次提交为 Epic 3 系列修复（并发保护、字段白名单、角色闭环、可见性边界）。
- `story-context.ts` 是上下文注入核心，已在 3-1/3-2/3-3 中反复加固，拥有 356+ 行测试。
- `story-bible-guards.ts` 建立了输入校验守护模式，可复用于 AI 写作参数验证。
- 21 个 AI 路由在 3-3 中统一传入 `user.id` 到 `fetchStoryContext()`，确保权限隔离。
- Vitest 已配置并可用，测试命令 `npm run test`。

## Latest Tech Information

- **TipTap ^3.20.0**：当前稳定版。`insertContent()` 支持字符串和 JSON 节点。`deleteRange()` + `insertContentAt()` 用于替换选区。`CharacterCount` 扩展自动追踪 characters/words。
- **Next.js 16.1.6**：使用 `proxy.ts` 替代已弃用的 `middleware.ts`。Route Handlers 支持 streaming Response（`new Response(ReadableStream)`）。
- **Vercel AI SDK (`ai` ^6.0.100)**：项目中引入但未直接用于流式——自定义 `createOpenAIStreamResponse()` 处理所有 OpenAI-compatible streaming。
- **Supabase SSR (`@supabase/ssr` ^0.8.0)**：cookie-based auth，`createClient()` 在 server/client 有不同实现。

## Project Context Reference

- [Source: `_bmad-output/project-context.md`#AI API Route 固定模式] — 所有 AI 端点必须遵循的 4 步链路
- [Source: `_bmad-output/project-context.md`#BYOK 数据流] — 客户端 localStorage → HTTP headers → 服务端 resolveAIConfig
- [Source: `_bmad-output/project-context.md`#Performance Gotchas] — Saliency 5s debounce, Autosave 1s debounce, fetchStoryContext 不缓存
- [Source: `_bmad-output/project-context.md`#Edge Cases Agents Must Handle] — TipTap 双存储、visibility 控制、prose_mode match-style 降级、空 apiKey（Ollama）
- [Source: `_bmad-output/project-context.md`#Security Rules] — X-AI-API-Key 不入日志、ai_history 不记录 API Key

## Story Completion Status

- Story status 设置为：`ready-for-dev`
- Completion note：Ultimate context engine analysis completed — 综合开发者指南已创建。已分析 epics、architecture、PRD、UX、project-context、前 3 个故事经验、最近 git 历史和现有代码库状态。

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

- create-story: 已读取 `workflow.yaml`、`instructions.xml`、`template.md`、`checklist.md`。
- create-story: 已从 `sprint-status.yaml` 自动定位首个 backlog 故事 `4-1-上下文写作能力-续写-改写-扩写-缩写`。
- create-story: 已分析 `epics.md`、`architecture.md`、`prd.md`、`ux-design-specification.md`、`project-context.md`。
- create-story: 已读取并分析前 3 个故事文件（3-1、3-2、3-3）的开发经验与 Review 反馈。
- create-story: 已分析最近 20 次 git 提交历史、文件变更模式和代码约定。
- create-story: 已深入分析现有 AI 路由（write/rewrite/expand/shrink）、核心库（story-context/openai-stream/resolve-config/prose-mode）、编辑器组件（editor-shell/ai-toolbar/selection-ai-menu/writing-editor）的完整代码。
- create-story: 关键发现——本故事约 70% 已实现，开发者核心任务是验证、修复和补测。
- dev-story: 审查全部 4 个 AI 路由 + 6 个前端组件 + 5 个核心 lib 文件。
- dev-story: 发现 3 个 bug：(1) saliencyMap 未传入 buildStoryPromptContext；(2) SelectionAIMenu 未接收 saliencyData prop；(3) AIToolbar 结果面板缺少"替换选区"按钮。
- dev-story: 修复全部 3 个 bug + 新增 39 个单元测试。lint/build/test 全部通过。

### Completion Notes List

1. **Bug 修复 — saliencyMap 未传入 AI 上下文**：4 个路由（write/rewrite/expand/shrink）均从请求 body 解构 `saliency` 并传入 `buildStoryPromptContext({ saliencyMap })` ，此前全部遗漏。
2. **Bug 修复 — SelectionAIMenu 缺少 saliencyData**：`WritingEditor` 组件未将 `saliencyData` prop 传递给 `SelectionAIMenu`，导致浮动菜单的 AI 调用不含场景上下文。
3. **Feature 补全 — AIToolbar 替换选区**：新增 `onReplaceSelection` 回调链路（AIToolbar → EditorShell → WritingEditor），并在结果面板中添加"替换选区"按钮。WritingEditor 新增 `replaceContent` prop，通过 TipTap `deleteRange + insertContentAt` 实现选区替换。
4. **测试覆盖**：新增 `context-writing.test.ts`（39 个测试），覆盖：saliency 注入（8 个）、prose mode override（5 个）、feature-aware context（7 个）、error classification（5 个）、readAIStream（2 个）、resolveAIConfig（5 个）、prose-mode（6 个）、extractRetryMeta（3 个）。
5. **Task 5 验证结论**：错误恢复管道已完整实现——`useAIRecovery` hook 处理 response error / fetch error / stream interruption，`RecoveryActionBar` 提供重试/切换模型操作，`openai-stream.ts` 将错误遥测写入 ai_history 表。TTFB > 3s 场景通过客户端 AbortController 3s 超时 + recovery bar 处理。

### Code Review Fixes (2026-02-28)

6. **H1 修复 — expand 路由添加 text 输入验证**：expand/route.ts 新增 `if (!text)` 校验，返回 400 + 可执行错误提示，防止 `text.slice()` 运行时崩溃。
7. **H2 修复 — shrink 路由添加 text 输入验证**：shrink/route.ts 新增 `if (!text)` 校验，与 rewrite 路由保持一致的防护模式。
8. **M1 修复 — 客户端 TTFB 3s 超时检测**：AIToolbar 和 SelectionAIMenu 的 fetch 调用新增 AbortController + 3s setTimeout，超时后触发 abort → recovery.handleFetchError 展示恢复操作栏，满足 AC5 的 3s 阈值要求。
9. **M2 修复 — replaceContent 重复触发**：EditorShell 的 handleReplaceSelection 追加 `\0` + timestamp 确保唯一性，WritingEditor 解析时剥离后缀，解决相同内容无法重复替换的问题。
10. **M3 修复 — shrink 路由 prompt 语言统一**：shrink/route.ts 的系统提示和用户提示从中文改为英文，与 write/rewrite/expand 保持一致。

### File List

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `src/app/api/ai/write/route.ts` | 修改 | 解构 `saliency`，传入 `buildStoryPromptContext` |
| `src/app/api/ai/rewrite/route.ts` | 修改 | 解构 `saliency`，传入 `buildStoryPromptContext` |
| `src/app/api/ai/expand/route.ts` | 修改 | 解构 `saliency`，传入 `buildStoryPromptContext` + text 输入验证 |
| `src/app/api/ai/shrink/route.ts` | 修改 | 解构 `saliency`，传入 `buildStoryPromptContext` + text 输入验证 + prompt 语言统一 |
| `src/components/editor/writing-editor.tsx` | 修改 | 新增 `saliencyData`/`replaceContent` props + replaceContent 唯一性解析 |
| `src/components/editor/editor-shell.tsx` | 修改 | 新增 `replaceContent` state + `handleReplaceSelection` 唯一性保证 |
| `src/components/ai/ai-toolbar.tsx` | 修改 | 新增 `onReplaceSelection` prop + "替换选区"按钮 + TTFB 3s 超时 |
| `src/components/editor/selection-ai-menu.tsx` | 修改 | TTFB 3s 超时检测 |
| `src/lib/ai/context-writing.test.ts` | 新增 | 39 个单元测试 |
| `package.json` | 修改 | test 脚本包含新测试文件 |
