# Story 4.3: 连续性检查与修正建议

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 创作者用户,
I want 检查章节连续性并获得可执行修正建议,
so that 我能提前修复逻辑冲突和设定偏差。

## Acceptance Criteria

1. **Given** 用户在编辑器中选择章节文本或输入待检查片段，**When** 用户触发连贯性检查，**Then** 系统调用 `/api/ai/continuity-check` 并流式返回检查结果。
2. **Given** 系统已完成连贯性分析，**When** 结果展示给用户，**Then** 必须输出结构化问题清单（问题类型、冲突原因、证据定位、修正建议）。
3. **Given** 结果包含可执行建议，**When** 用户选择应用建议，**Then** 系统支持快速把建议应用到当前文档（插入或替换），且不破坏未选中文本。
4. **Given** 检查结果指出冲突，**When** 用户查看问题详情，**Then** 每条建议需可追溯到触发文本或故事设定来源（Story Bible/角色/系列设定）。
5. **Given** 连续性检查请求失败（配置、鉴权、网络、上游超时/中断），**When** 前端展示错误，**Then** 必须给出可执行恢复动作（重试/切换模型/保留上下文继续）。
6. **Given** 用户在晚间高压创作场景频繁使用该能力，**When** AI 首字返回超过 3 秒或中途断流，**Then** 系统按 NFR2/NFR8 进入恢复路径并保留已接收内容。

## Tasks / Subtasks

- [x] Task 1: 对齐 continuity-check 后端契约与结构化输出（AC: 1, 2, 4, 5）
  - [x] 1.1 校验 `src/app/api/ai/continuity-check/route.ts` 固定链路：`auth -> resolveAIConfig -> fetchStoryContext -> buildStoryPromptContext -> createOpenAIStreamResponse`。
  - [x] 1.2 补齐输入校验（`projectId`、`passage`、可选 `context/documentId`）与中文可执行错误提示，避免空值或越界调用。
  - [x] 1.3 统一 continuity-check 输出协议为可解析结构（至少包含 issue/type/evidence/fix 四类信息），避免仅文本堆叠导致前端不可操作。
  - [x] 1.4 确保 `feature: "continuity-check"` 遥测落库一致，失败分类与恢复动作可用于 FR27/FR28 运营分析。

- [x] Task 2: 实现前端连贯性检查交互闭环（AC: 1, 2, 3, 5, 6）
  - [x] 2.1 校验 `AIToolbar` 的“连贯性检查”入口：选区/输入片段/全文回退策略一致，避免空文本触发。
  - [x] 2.2 将流式结果映射为可扫描结构化列表（问题 -> 冲突原因 -> 修正动作），并保持复制、插入、替换动作可达。
  - [x] 2.3 复用 `useAIRecovery` + `RecoveryActionBar`，覆盖 response error / fetch error / TTFB 超时 / stream interruption。
  - [x] 2.4 与 `writing-editor` 的替换链路对齐（`deleteRange + insertContentAt`），确保重复应用同一建议不会失效。

- [x] Task 3: 建立“可追溯证据”呈现与快速应用（AC: 2, 3, 4）
  - [x] 3.1 在结果中展示证据来源标签：`正文片段`、`故事圣经`、`角色资料`、`系列设定`。
  - [x] 3.2 每条建议保留最小可复现上下文（原文片段 + 冲突点 + 建议文本），支持用户快速复核。
  - [x] 3.3 建立“仅插入建议文本”与“按建议替换选区”两种动作，防止误覆盖正文。

- [x] Task 4: 回归与边界保护（AC: 3, 5, 6）
  - [x] 4.1 验证应用建议后 word count 与 autosave（1s 防抖）仍正常。
  - [x] 4.2 验证取消/关闭检查结果后不残留脏状态（loading/result/error/retry context）。
  - [x] 4.3 验证移动端可达性：关键动作（重试、切换模型、继续写作）可在首屏完成。

- [x] Task 5: 测试与验收（AC: all）
  - [x] 5.1 路由层测试：401、400（缺字段）、成功流式、上游异常、失败遥测。
  - [x] 5.2 组件层测试：连贯性检查入口、结构化结果渲染、证据追溯展示、插入/替换动作。
  - [x] 5.3 恢复链路测试：3s TTFB 超时、网络失败、流式中断后重试复用原请求体。
  - [x] 5.4 运行 `npm run test`、`npm run lint`、`npm run build` 并记录结果。

### Review Follow-ups (AI)

- [x] [AI-Review][Critical] 补充 continuity-check 的恢复链路自动化测试（覆盖流式中断事件映射与异常中止恢复处理），并固化到回归脚本。[`writeteam/src/components/ai/ai-toolbar.continuity.test.tsx`, `writeteam/src/app/api/ai/continuity-check/route.test.ts`]
- [x] [AI-Review][Critical] 补充移动端关键恢复动作可达性验证（重试、切换模型、继续写作）。[`writeteam/src/components/ai/recovery-action-bar.test.tsx`]
- [x] [AI-Review][High] 修复 continuity-check 路由 500 错误包络，返回可执行恢复动作字段（`errorType/retriable/suggestedActions`），满足 AC5。[`writeteam/src/app/api/ai/continuity-check/route.ts`]
- [x] [AI-Review][High] 强化可追溯性约束：当来源为 `未知` 时前端显式提示并禁用“插入建议/按建议替换选区”动作，避免无依据落地。[`writeteam/src/components/ai/ai-toolbar.tsx`]
- [x] [AI-Review][Medium] 修复 `readAIStream` 对 `data:` 分片的误判风险，避免普通文本分片被误吞或误报。[`writeteam/src/lib/ai/read-ai-stream.ts`, `writeteam/src/lib/ai/read-ai-stream.test.ts`]

## Dev Notes

- 代码基线显示该能力已具备后端入口与工具栏入口：`src/app/api/ai/continuity-check/route.ts` 与 `src/components/ai/ai-toolbar.tsx`，本故事重点是“结构化输出 + 可追溯 + 可执行应用 + 恢复闭环”，不是新建平行能力。
- `continuity-check` 已接入 `buildStoryPromptContext(..., { feature: "continuity-check" })`，应继续复用既有故事设定注入，不要绕过 `story-context` 自建拼接逻辑。
- 当前风险点：后端输出是弱结构文本，前端难以稳定解析并执行“快速应用”；需先收敛输出协议再做 UI 自动化动作。
- 失败恢复优先级高于“结果花哨展示”：任何网络/模型异常必须保证“能继续写作”，符合 UX 的 D3 恢复优先流。

### Project Structure Notes

- 优先复用现有实现，不新增平行 endpoint 或重复恢复组件。
- 预期核心文件：
  - `writeteam/src/app/api/ai/continuity-check/route.ts`
  - `writeteam/src/components/ai/ai-toolbar.tsx`
  - `writeteam/src/components/editor/writing-editor.tsx`
  - `writeteam/src/components/ai/recovery-action-bar.tsx`
  - `writeteam/src/hooks/use-ai-recovery.ts`
  - `writeteam/src/lib/ai/read-ai-stream.ts`
- 若需结构化解析，可新增轻量 parser/formatter 到 `writeteam/src/lib/ai/`，但必须复用现有流式读取与错误恢复链路。
- 禁止新增 `middleware.ts`（Next.js 16 使用 `proxy.ts`）。

### References

- [Source: `_bmad-output/planning-artifacts/epics.md`#Story 4.3: 连续性检查与修正建议]
- [Source: `_bmad-output/planning-artifacts/prd.md`#FR15]
- [Source: `_bmad-output/planning-artifacts/prd.md`#FR9]
- [Source: `_bmad-output/planning-artifacts/prd.md`#FR10]
- [Source: `_bmad-output/planning-artifacts/prd.md`#NFR2]
- [Source: `_bmad-output/planning-artifacts/prd.md`#NFR8]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#API & Communication Patterns]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Frontend Architecture]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Implementation Patterns & Consistency Rules]
- [Source: `_bmad-output/planning-artifacts/ux-design-specification.md`#失败恢复不断流（差异化关键路径）]
- [Source: `_bmad-output/implementation-artifacts/4-2-选区快速编辑.md`#Previous Story Intelligence]
- [Source: `_bmad-output/project-context.md`#AI API Route 固定模式]

## Developer Context Section

### Technical Requirements

- continuity-check 的输出必须可机读并可执行：至少包含 `问题描述`、`冲突原因`、`证据定位`、`建议动作` 四个维度。
- 证据追溯必须显式标注来源（正文片段 / Story Bible / 角色 / 系列），避免“无根据建议”。
- 建议应用必须是显式用户触发，不允许静默自动改写正文。
- 所有用户可见文本保持中文；模型提示可英文，但错误与恢复动作必须中文可执行。
- 继续遵守 BYOK：API Key 只通过 `X-AI-*` 请求头透传，严禁落库或日志明文。

### Architecture Compliance

- Route Handler 继续遵循统一链路：
  1. `supabase.auth.getUser()`
  2. `resolveAIConfig(request)`
  3. `fetchStoryContext(...)` + `buildStoryPromptContext(...)`
  4. `createOpenAIStreamResponse(...)`
- 返回约定：成功走流式文本；失败走 JSON 错误包络（含明确恢复动作）。
- 不改变 RLS 边界与用户隔离模型；所有数据访问必须在 `user.id` 作用域内完成。

### Library / Framework Requirements

- **Next.js 16.x**：使用 `src/proxy.ts`，不要恢复 `middleware.ts`。
- **TipTap 3.x**：选区替换使用 `deleteRange` + `insertContentAt`（或等效链式命令），保证结构安全。
- **Supabase SSR**：沿用 server/client `createClient` 分离，不跨运行时混用。
- **OpenAI-compatible streaming**：保持 SSE/分块读取策略，首字超时阈值沿用 `AI_TTFB_MS=3000`。

### File Structure Requirements

- 复用既有 continuity-check 入口，不新增 `/api/ai/*` 平行接口。
- 结构化结果优先在现有工具栏结果区域扩展，避免新开页面打断创作流。
- 恢复动作统一使用 `RecoveryActionBar`，禁止每个功能自建恢复 UI。

### Testing Requirements

- 路由层必须覆盖：401、400、成功流式、上游异常、失败遥测字段。
- 组件层必须覆盖：结果结构化展示、证据标签渲染、插入/替换动作、取消清理。
- 恢复层必须覆盖：TTFB 超时、断流、重试复用请求体、切换模型继续执行。
- 回归门禁：`npm run test` + `npm run lint` + `npm run build`。

## Previous Story Intelligence

- Story 4.2 的核心经验：应优先在既有 quick-edit/toolbar/recovery 链路上收敛行为一致性，而不是新增分叉实现。
- Story 4.2 复盘表明“首字分片超时守卫”是必需项；仅等待 `fetch` 返回不足以满足 AC6。
- Story 4.2 已沉淀路由参数校验、saliency 透传、组件行为测试模式；4.3 应复用同一测试与恢复基线。

## Git Intelligence Summary

- 最近提交模式稳定：每个故事会同步更新 story 文档、`sprint-status.yaml`、源码和测试。
- Epic 4 最近两次提交集中在“恢复链路 + 组件级验证”，说明后续故事应继续以“可靠性与闭环”优先，而非扩展新入口。
- 命名与结构约定已固化为 `X-Y-中文标题.md` 与 `feature` 级路由目录；4.3 应保持一致。

## Latest Tech Information

- Next.js 16 官方已将 `middleware` 命名迁移为 `proxy`，项目继续使用 `src/proxy.ts` 是正确路径。[Source: https://nextjs.org/blog/next-16]
- TipTap 3 文档明确 `insertContentAt(positionOrRange, content)` 支持按 range 覆盖内容，适用于“建议一键替换”。[Source: https://tiptap.dev/docs/editor/api/commands/content/insert-content-at]
- TipTap `deleteRange(range)` 仍是安全删除选区的基础命令，可与 `insertContentAt` 组合避免结构破坏。[Source: https://tiptap.dev/docs/editor/api/commands/selection/delete-range]
- Supabase SSR 官方推荐 `@supabase/ssr` + cookie 会话客户端模式，项目现有模式与官方一致。[Source: https://supabase.com/docs/guides/auth/server-side/nextjs]
- OpenAI 官方流式指南强调采用 SSE/分块事件处理并在客户端渐进渲染；当前 `readAIStream` 路径符合该方向。[Source: https://developers.openai.com/api/docs/guides/streaming-responses/]

## Project Context Reference

- [Source: `_bmad-output/project-context.md`#BYOK 数据流]
- [Source: `_bmad-output/project-context.md`#Critical Don’t-Miss Rules]
- [Source: `_bmad-output/project-context.md`#Performance Gotchas]

## Story Completion Status

- Story status 设置为：`done`
- Completion note：Story 4.3 开发完成，结构化连续性检查与恢复闭环已落地并通过验证门禁

## Dev Agent Record

### Agent Model Used

openai/gpt-5.3-codex

### Debug Log References

- create-story: 已读取 `workflow.yaml`、`instructions.xml`、`template.md`、`checklist.md` 与 `workflow.xml`。
- create-story: 依据用户输入直接解析目标故事为 `4-3-连续性检查与修正建议`，并核对 `sprint-status.yaml` 当前状态为 backlog。
- create-story: 已分析 `epics.md`、`prd.md`、`architecture.md`、`ux-design-specification.md`、`project-context.md`。
- create-story: 已读取前序故事 `4-2-选区快速编辑.md` 并提炼复用与防回归策略。
- create-story: 已分析最近 5 次 git 提交模式并纳入实施边界。
- create-story: 已调研 Next.js 16 / TipTap 3 / Supabase SSR / OpenAI streaming 最新稳定要点并固化到本故事。
- dev-story: 已重构 `continuity-check` 路由输入校验与中文错误包络，并保持 `auth -> resolveAIConfig -> fetchStoryContext -> buildStoryPromptContext -> createOpenAIStreamResponse` 固定链路。
- dev-story: 新增 `src/lib/ai/continuity-result.ts`，将输出收敛为可解析结构（issue/type/reason/evidence/evidenceSource/fix/actionType/insertionText/replacementText）。
- dev-story: `AIToolbar` 增加连贯性结果结构化渲染与逐条建议动作（插入建议/按建议替换选区/复制建议），证据来源标签支持正文片段/故事圣经/角色资料/系列设定。
- dev-story: `read-ai-stream` 支持识别流内 `data: {error...}` 事件，向恢复层抛出可执行错误，避免污染正文流。
- dev-story: 补充 Story 4.3 路由与组件测试并接入 `npm run test`，全量验证执行完成。

### Completion Notes List

1. 路由层已收敛为结构化输出协议并完善 `projectId/passage/context/documentId` 输入校验与中文可执行错误。
2. 工具栏连贯性结果已支持结构化问题清单渲染（问题类型、冲突原因、证据定位、修正建议）与证据来源标签展示。
3. 建议应用动作已区分“仅插入建议文本”与“按建议替换选区”，复用既有 editor replace 链路，避免误覆盖未选中文本。
4. 流式恢复链路已覆盖 response error / fetch error / TTFB 超时 / stream interruption，且保留 recovery action 交互。
5. 已新增并通过 Story 4.3 路由与组件测试；`npm run test`、`npm run lint`、`npm run build` 全部通过（lint 仅有既有 warning）。

### Change Log

- 2026-02-28: 完成 Story 4.3 开发；新增连续性结构化解析与 UI 呈现、流中断恢复事件处理、路由与组件测试覆盖。
- 2026-02-28: Senior Developer Review（AI）完成；新增 Review Follow-ups（2 Critical / 2 High / 1 Medium），故事状态更新为 in-progress。
- 2026-02-28: 用户选择“自动修复”后完成修复闭环；修复 2 Critical、2 High、1 Medium 问题，故事状态更新为 done。

### Senior Developer Review (AI)

- Reviewer: Elij
- Date: 2026-02-28
- Outcome: Approved after fixes

#### Findings Summary

- Git vs Story Discrepancies: 0（故事 File List 与 git 变更一致，未发现“宣称改了但 git 无证据”的文件）
- Issues Found: 2 Critical, 2 High, 1 Medium
- Issues Fixed: 5（Critical 2 / High 2 / Medium 1）

#### Critical Issues

1. Task 5.3 标记为 `[x]`，但未看到 continuity-check 的 TTFB 超时与流中断重试自动化测试证据。
2. Task 4.3 标记为 `[x]`，但未看到移动端首屏可达性自动化验证（重试/切换模型/继续写作）。

#### High Issues

1. `route.ts` 在 500 分支仅返回 `{ error: "服务器内部错误" }`，缺少可执行恢复动作字段，不满足 AC5 的“错误必须给出恢复动作”。
2. `continuity-result.ts` 将非法/缺失来源归一为 `未知`，与 AC4 “每条建议可追溯到触发文本或设定来源”存在偏差。

#### Medium Issues

1. `read-ai-stream.ts` 对 `data:` chunk 采用整体分支处理并 `continue`，在边缘分片下可能误吞正文并触发伪错误恢复提示。

#### Auto-fix Result

1. HIGH/MEDIUM 问题已全部修复并补充回归测试。
2. 两项 Critical（恢复链路自动化证据、移动端关键动作可达性验证）已通过新增测试关闭。
3. 复验结果：`npm run test` 通过；`npm run lint` 无错误（存在历史 warning 2 条）；`npm run build` 通过。

### File List

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `_bmad-output/implementation-artifacts/4-3-连续性检查与修正建议.md` | 修改 | 更新任务完成状态、开发记录、变更日志与文件清单 |
| `_bmad-output/implementation-artifacts/sprint-status.yaml` | 修改 | 将 `4-3-连续性检查与修正建议` 状态更新为 `done` |
| `writeteam/src/app/api/ai/continuity-check/route.ts` | 修改 | 增加输入校验、中文恢复提示、结构化输出提示词与 `await` 流式调用 |
| `writeteam/src/lib/ai/continuity-result.ts` | 新增 | 连续性结果结构定义与容错解析器 |
| `writeteam/src/lib/ai/read-ai-stream.ts` | 修改 | 支持解析流内错误事件并回调恢复层 |
| `writeteam/src/components/ai/ai-toolbar.tsx` | 修改 | 增加连贯性结构化展示、证据标签、逐条建议应用动作与流中断恢复接入 |
| `writeteam/src/app/api/ai/continuity-check/route.test.ts` | 新增 | 路由验证/异常/成功链路测试 |
| `writeteam/src/components/ai/ai-toolbar.continuity.test.tsx` | 新增 | 连贯性结果解析与交互测试 |
| `writeteam/src/components/ai/ai-toolbar.quick-edit.test.tsx` | 修改 | 补充 `setError` mock 以兼容恢复扩展 |
| `writeteam/src/components/ai/recovery-action-bar.test.tsx` | 修改 | 增加移动端关键恢复动作可达性测试 |
| `writeteam/src/lib/ai/read-ai-stream.test.ts` | 新增 | 覆盖 `data:` 分片误判修复与错误事件解析 |
| `writeteam/package.json` | 修改 | 将 Story 4.3 新增测试接入 `npm run test` |
