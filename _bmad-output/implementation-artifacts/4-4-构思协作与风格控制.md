# Story 4.4: 构思协作与风格控制

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 创作者用户,
I want 通过头脑风暴、场景规划、反转建议、对话协作与风格模式控制创作方向,
so that 我能持续获得高质量且风格一致的文本。

## Acceptance Criteria

1. **Given** 用户在当前项目上下文中打开 AI 对话与构思工具，**When** 用户发起 brainstorm/scene-plan/twist/chat 并切换 prose mode，**Then** 系统返回与当前项目一致的建议和文本输出。
2. **Given** 用户在同一写作会话内多轮使用构思与对话能力，**When** 用户追问、补充或要求重写建议，**Then** 系统保持会话上下文连续并能引用当前文档与故事设定。
3. **Given** 用户切换 prose mode（balanced/cinematic/lyrical/minimal/match-style），**When** 再次触发构思或对话生成，**Then** 输出在语气、节奏和表达上出现可感知差异。
4. **Given** AI 请求失败或模型不可用，**When** 系统返回失败结果，**Then** 前端提供可执行恢复动作（重试、切换模型、保留上下文继续），且不破坏当前写作内容。

## Tasks / Subtasks

- [x] Task 1: 对齐构思协作后端契约并统一风格参数透传（AC: 1, 2, 3）
  - [x] 1.1 校验并统一 `brainstorm/scene-plan/twist/chat` 路由的输入结构（`projectId`、`documentId`、`context`、`proseMode`、功能专属字段）。
  - [x] 1.2 在 `brainstorm` 与 `twist` 路由补齐 `proseMode` 透传到 `buildStoryPromptContext(..., { feature, proseMode })`，与 `scene-plan`、`chat` 对齐。
  - [x] 1.3 收敛四个路由的错误包络语义与中文提示，保证失败时可进入统一恢复链路。
  - [x] 1.4 保障四个能力的遥测特征值稳定（feature 分别为 `brainstorm`/`scene-plan`/`twist`/`chat`），便于后续 FR27/FR28 分析。

- [x] Task 2: 实现会话内构思协作与风格控制闭环（AC: 1, 2, 3）
  - [x] 2.1 在编辑器右侧面板（AI Chat / Muse）校验多轮消息与当前文档上下文拼接策略，避免上下文丢失或串场。
  - [x] 2.2 为 prose mode 切换建立显式状态可见性（当前模式标签、切换后生效提示、会话内可追踪）。
  - [x] 2.3 为 `match-style` 模式增加降级策略提示：缺少 `style_sample` 时回落 `balanced`，并向用户说明原因。
  - [x] 2.4 保证生成建议可直接转入写作流程（插入正文或复制到编辑区）且不中断当前编辑。

- [x] Task 3: 失败恢复与不中断写作保障（AC: 4）
  - [x] 3.1 复用 `useAIRecovery` 与 `RecoveryActionBar`，覆盖 response error、fetch error、TTFB 超时、stream interruption。
  - [x] 3.2 保证重试与切换模型时复用原请求体（含最新 context 与 proseMode），避免恢复后语义漂移。
  - [x] 3.3 验证恢复失败时仍可保留当前草稿并继续手动写作，不出现编辑器锁死。

- [x] Task 4: 测试与验收（AC: all）
  - [x] 4.1 路由层测试：四个端点的 401、400、成功流式、上游异常、恢复错误包络。
  - [x] 4.2 组件层测试：多轮对话上下文连续性、prose mode 切换可感知影响、`match-style` 降级反馈。
  - [x] 4.3 恢复链路测试：重试、切换模型、保留上下文继续在桌面与移动端可达。
  - [x] 4.4 运行 `npm run test`、`npm run lint`、`npm run build` 并记录结果。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 已为 `brainstorm` 前置上下文阶段补齐统一错误包络，异常返回可恢复语义 [writeteam/src/app/api/ai/brainstorm/route.ts:51]
- [x] [AI-Review][HIGH] 已为 `scene-plan` 前置上下文阶段补齐统一错误包络，异常返回可恢复语义 [writeteam/src/app/api/ai/scene-plan/route.ts:54]
- [x] [AI-Review][HIGH] 已为 `twist` 前置上下文阶段补齐统一错误包络，异常返回可恢复语义 [writeteam/src/app/api/ai/twist/route.ts:49]
- [x] [AI-Review][HIGH] 已为 `chat` 前置上下文阶段补齐统一错误包络，异常返回可恢复语义 [writeteam/src/app/api/ai/chat/route.ts:74]
- [x] [AI-Review][MEDIUM] AI Chat 对成功但空流体响应改为显式恢复错误，不再追加空 assistant 消息 [writeteam/src/components/ai/ai-chat-panel.tsx:117]
- [x] [AI-Review][MEDIUM] Muse 对成功但空流体响应改为显式恢复错误，避免静默失败 [writeteam/src/components/ai/muse-panel.tsx:147]
- [x] [AI-Review][MEDIUM] 已补充移动端视口下空流体恢复测试，验证恢复动作触发路径 [writeteam/src/components/ai/muse-panel.test.tsx:114]
- [x] [AI-Review][MEDIUM] Story 状态字段已与完成区块对齐，消除审计歧义 [D:/writeteam/_bmad-output/implementation-artifacts/4-4-构思协作与风格控制.md:3]

## Dev Notes

- Story 4.4 不是新建平行能力，而是在现有 `brainstorm`、`scene-plan`、`twist`、`chat` 基础上完成“上下文一致 + 风格可控 + 多轮协作 + 失败可恢复”闭环。
- 已有链路显示 `scene-plan` 与 `chat` 已接入 `proseMode`，而 `brainstorm`、`twist` 尚未统一透传，属于本故事高优先修复点。
- `prose_mode` 的五种风格与 `match-style` 的样本依赖已在 `src/lib/ai/prose-mode.ts` 实现，需保证前后端联动不偏离该单一事实源。
- 失败恢复必须遵循 D3“恢复优先流”：先保上下文与草稿，再提供重试或切换模型，不让用户离开写作主链路。

### Project Structure Notes

- 优先修改并复用现有文件：
  - `writeteam/src/app/api/ai/brainstorm/route.ts`
  - `writeteam/src/app/api/ai/scene-plan/route.ts`
  - `writeteam/src/app/api/ai/twist/route.ts`
  - `writeteam/src/app/api/ai/chat/route.ts`
  - `writeteam/src/lib/ai/prose-mode.ts`
  - `writeteam/src/components/ai/*`（对话面板、恢复动作条、模式切换相关组件）
- 严禁新增 `middleware.ts`；Next.js 16 使用 `src/proxy.ts`。
- 所有 AI 路由继续遵循固定链路：`auth -> resolveAIConfig -> fetchStoryContext -> buildStoryPromptContext -> createOpenAIStreamResponse`。

### References

- [Source: `_bmad-output/planning-artifacts/epics.md`#Epic 4: AI 写作与改写主流程]
- [Source: `_bmad-output/planning-artifacts/epics.md`#Story 4.4: 构思协作与风格控制]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#API & Communication Patterns]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Frontend Architecture]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Implementation Patterns & Consistency Rules]
- [Source: `_bmad-output/planning-artifacts/ux-design-specification.md`#失败恢复不断流（差异化关键路径）]
- [Source: `_bmad-output/planning-artifacts/ux-design-specification.md`#Journey Patterns]
- [Source: `_bmad-output/project-context.md`#AI API Route 固定模式]
- [Source: `_bmad-output/project-context.md`#BYOK 数据流]
- [Source: `_bmad-output/implementation-artifacts/4-3-连续性检查与修正建议.md`#Previous Story Intelligence]

## Developer Context Section

### Technical Requirements

- 四个构思协作端点必须在同一请求语义下工作：统一 project/document/context/proseMode 处理与错误语义。
- 生成结果必须可用于写作动作，不允许只提供不可执行建议文本。
- 多轮对话必须优先复用当前会话与项目上下文，避免将历史上下文截断到不可追问。
- 用户可见反馈保持中文，且错误必须附带下一步动作。

### Architecture Compliance

- Route Handler 必须包含 `supabase.auth.getUser()` 门禁，不允许匿名调用。
- BYOK 只经 `X-AI-*` 头透传，禁止持久化 API Key。
- Prompt 构建统一经 `buildStoryPromptContext`，不得绕过 `story-context` 私自拼接项目设定。
- 非流式失败返回 JSON 错误包络，流式成功返回文本流。

### Library / Framework Requirements

- **Next.js 16**：遵循 `proxy.ts` 约定，不使用 `middleware.ts`。
- **React 19 + App Router**：编辑器与右侧面板交互保持 Client Component，鉴权与 AI 调度留在服务端路由。
- **TipTap 3**：与编辑器集成时沿用既有插入/替换模式，避免破坏文档结构。
- **Supabase SSR + RLS**：所有查询保持用户作用域隔离。

### File Structure Requirements

- 优先在现有 `src/app/api/ai/*/route.ts` 与 `src/components/ai/*` 内增量实现，避免新增平行目录。
- 风格模式逻辑集中在 `src/lib/ai/prose-mode.ts`，调用方只传入模式与样本，不复制策略代码。
- 与故事上下文相关逻辑集中在 `src/lib/ai/story-context.ts`，禁止在 UI 层拼接业务上下文。

### Testing Requirements

- 每个受影响端点至少覆盖：未登录、参数缺失、成功流式、上游失败。
- 对话/构思组件至少覆盖：多轮上下文、模式切换影响、失败恢复动作可点击并可重试。
- 移动端至少验证恢复主动作（重试/切换模型/继续写作）在首屏可达。
- 执行门禁：`npm run test`、`npm run lint`、`npm run build`。

## Previous Story Intelligence

- Story 4.3 已完成“结构化结果 + 恢复动作 + 流式中断处理”闭环，4.4 应复用其恢复机制与测试模式。
- Story 4.3 证明“先收敛协议，再做 UI 行为”可降低返工；4.4 同样应先统一四个路由输入/错误语义。
- Epic 4 最近提交集中在恢复链路与可追溯性增强，说明本故事应继续以可靠性优先，而非功能散点扩张。

## Git Intelligence Summary

- 最近 5 次提交中，Epic 4 连续两次围绕 Story 4.2/4.3 修复，主线是“恢复闭环 + 组件验证”。
- 相关提交反复修改 `src/app/api/ai/*`、`src/components/ai/*` 与测试文件，表明 4.4 应保持同样的实现落点和验证深度。
- 故事文档命名与状态管理已稳定采用 `X-Y-中文标题.md` + `sprint-status.yaml`，本故事保持一致。

## Latest Tech Information

- Next.js 16 已明确以 `proxy` 取代 `middleware` 命名，当前项目使用 `src/proxy.ts` 是正确路径。[Source: https://nextjs.org/blog/next-16]
- TipTap 官方 API 对 prose 样式与编辑命令保持稳定，建议继续通过命令式接口与扩展体系实现文本写作流整合。[Source: https://tiptap.dev/docs/editor/getting-started/overview]
- Supabase Next.js SSR 推荐继续使用 `@supabase/ssr` 的服务端/客户端拆分模式，匹配项目当前鉴权模式。[Source: https://supabase.com/docs/guides/auth/server-side/nextjs]
- OpenAI 官方流式响应建议使用 SSE 分块渐进渲染并处理中断恢复，契合本故事“失败可恢复”要求。[Source: https://platform.openai.com/docs/guides/streaming-responses]

## Project Context Reference

- [Source: `_bmad-output/project-context.md`#Technology Stack & Versions]
- [Source: `_bmad-output/project-context.md`#Critical Don’t-Miss Rules]
- [Source: `_bmad-output/project-context.md`#Performance Gotchas]

## Story Completion Status

- Story status 设置为：`done`
- Completion note：Ultimate context engine analysis completed - comprehensive developer guide created

## Dev Agent Record

### Agent Model Used

openai/gpt-5.3-codex

### Debug Log References

- create-story: 已读取 `workflow.yaml`、`instructions.xml`、`template.md`、`checklist.md` 与 `workflow.xml`。
- create-story: 已从 `sprint-status.yaml` 自动发现首个 backlog 故事为 `4-4-构思协作与风格控制`。
- create-story: 已完成 `epics.md`、`architecture.md`、`ux-design-specification.md`、`project-context.md`、前序故事 `4-3`、最近提交历史分析。

### Completion Notes List

1. 已建立 Story 4.4 的完整开发上下文与 guardrails，覆盖接口、组件、恢复链路与测试门禁。
2. 已明确四个构思协作端点的统一改造方向和与 prose mode 的对齐要求。
3. 已固化与 Epic 4 既有实现一致的复用策略，降低重复造轮子风险。
4. 已完成四个协作端点契约统一：补齐 `brainstorm/twist` 的 `proseMode` 透传，并统一 `projectId/documentId/context` 校验与可恢复错误包络。
5. 已完成右侧 `AI Chat/Muse` 的 prose mode 显式可见与可追踪状态；`match-style` 缺失 `style_sample` 时自动回落 `balanced` 并提示原因。
6. 已完成 Muse 恢复闭环接入（`useAIRecovery` + `RecoveryActionBar`），并确保重试/切换模型复用原请求体（含最新 context/proseMode）。
7. 已补充 Story 4.4 相关测试：协作路由契约测试、AI Chat 与 Muse 组件测试，并通过 `npm run test`、`npm run lint`、`npm run build`。

### File List

- `_bmad-output/implementation-artifacts/4-4-构思协作与风格控制.md`（新增）
- `_bmad-output/implementation-artifacts/4-4-构思协作与风格控制.md`（更新：任务勾选、状态、完成记录、文件清单）
- `_bmad-output/implementation-artifacts/sprint-status.yaml`（更新：`4-4-构思协作与风格控制` -> `done`）
- `writeteam/package.json`（更新：`test` 脚本纳入 Story 4.4 新增测试文件）
- `writeteam/src/lib/ai/prose-mode.ts`（更新：`match-style` 无样本时回落 `balanced`，并注入回落提示）
- `writeteam/src/app/api/ai/brainstorm/route.ts`（更新：输入契约校验、`proseMode` 透传、统一错误包络）
- `writeteam/src/app/api/ai/scene-plan/route.ts`（更新：输入契约校验、统一错误包络）
- `writeteam/src/app/api/ai/twist/route.ts`（更新：输入契约校验、`proseMode` 透传、统一错误包络）
- `writeteam/src/app/api/ai/chat/route.ts`（更新：消息数组校验、输入契约校验、统一错误包络）
- `writeteam/src/app/api/ai/muse/route.ts`（更新：输入契约校验、`proseMode` 透传、统一错误包络）
- `writeteam/src/components/ai/ai-chat-panel.tsx`（更新：prose mode 可见性、`match-style` 回落提示、建议插入正文）
- `writeteam/src/components/ai/muse-panel.tsx`（更新：prose mode 可见性、恢复动作条接入、`match-style` 回落提示）
- `writeteam/src/components/editor/editor-shell.tsx`（更新：向 Chat/Muse 传递 `documentId`、`style_sample` 可用性与插入回调）
- `writeteam/src/app/api/ai/collab-routes.contract.test.ts`（新增：四个协作端点契约、遥测稳定性与上下文异常包络测试）
- `writeteam/src/components/ai/ai-chat-panel.test.tsx`（新增：多轮上下文/模式回落、插入正文、空流体恢复测试）
- `writeteam/src/components/ai/muse-panel.test.tsx`（新增：模式回落、请求体透传与空流体恢复测试）

### Senior Developer Review (AI)

- Review Date: 2026-02-28
- Reviewer: Elij
- Outcome: Approved
- Summary: 高优先级与中优先级审查项已全部闭环：四路由前置上下文异常已统一包络，Chat/Muse 空流体场景已转入可恢复错误，移动端恢复可达测试已补齐；当前实现满足 Story 4.4 的可恢复主链路验收要求。

### Change Log

- 2026-02-28: Senior Developer Review (AI) 完成；新增审查结论、Follow-up 清单，并将 Story 状态回调为 in-progress。
- 2026-02-28: 根据“自动修复全部”执行 High/Medium 问题修复并补充测试，复审通过，Story 状态更新为 done。
