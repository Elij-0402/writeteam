# Story 6.1: AI 结果正负反馈闭环

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 创作者用户,
I want 对 AI 输出进行正负反馈,
so that 系统和团队能持续优化生成质量与推荐策略。

## Acceptance Criteria

1. **Given** 用户收到 AI 生成结果，**When** 用户提交正向或负向反馈，**Then** 反馈与上下文调用记录关联存储。
2. **Given** 用户收到 AI 生成结果，**When** 用户提交反馈，**Then** 反馈提交不阻塞用户继续写作。

## Tasks / Subtasks

- [x] Task 1: 完成反馈提交通路的接口与鉴权收敛（AC: 1）
  - [x] 1.1 复用并加固 `POST /api/ai/feedback` 的参数校验、错误语义与幂等约束（同一响应仅可反馈一次）。
  - [x] 1.2 保证反馈写入目标仍为 `ai_history.user_rating/rated_at`，并与 `project_id + feature + response_fingerprint + user_id` 关联。
  - [x] 1.3 统一失败返回 JSON 错误包络，避免前端出现不可判别错误。
- [x] Task 2: 完成编辑器侧反馈交互闭环（AC: 1, 2）
  - [x] 2.1 在 AI 结果面板中保持“点赞/点踩”单次提交约束，提交中禁用重复点击。
  - [x] 2.2 反馈成功后提供即时中文反馈（toast/按钮态），且不重置当前写作上下文与编辑状态。
  - [x] 2.3 反馈失败时提供可执行提示（重试或稍后再试），不清空生成结果。
- [x] Task 3: 数据约束与可观测性（AC: 1）
  - [x] 3.1 校验数据库约束保持 `user_rating in (-1, 1)`，并验证索引 `response_fingerprint`、`user_id+user_rating` 可用。
  - [x] 3.2 确认反馈记录与既有遥测字段（`feature/model/error_type/recovery_status`）可联合查询，为 6.2 失败分析提供输入。
- [x] Task 4: 测试与门禁（AC: all）
  - [x] 4.1 为 `/api/ai/feedback` 增加路由测试：未登录、参数非法、重复反馈、成功写入。
  - [x] 4.2 为 `AIToolbar` 增加交互测试：成功反馈、失败反馈、提交中禁用与不阻塞写作行为。
  - [x] 4.3 执行 `npm run lint` 与 `npm run build`，记录结果。

## Dev Notes

- 本故事是 Epic 6 的第一故事，将直接为 Story 6.2（失败类型定位）和 Story 6.3（排障建议）提供数据基础。
- 代码库已有反馈基础实现：`writeteam/src/app/api/ai/feedback/route.ts` 与 `writeteam/src/components/ai/ai-toolbar.tsx`，本故事应以“加固与补测”为主，禁止重复造轮子。
- 反馈关联键以 `response_fingerprint` 为核心，需确保与流式结果指纹计算逻辑一致（`writeteam/src/lib/ai/openai-stream.ts` 与 `AIToolbar.hashText`）。

### Project Structure Notes

- 主要落点：
  - `writeteam/src/app/api/ai/feedback/route.ts`
  - `writeteam/src/components/ai/ai-toolbar.tsx`
  - `writeteam/src/lib/ai/openai-stream.ts`（仅在需要对齐指纹/遥测语义时修改）
  - `writeteam/src/types/database.ts`（仅在字段约束变更时同步）
  - `writeteam/supabase/migrations/002_ai_quality_observability.sql`（仅在约束/索引需补充时）
- 保持现有分层：UI 不直接写库；反馈写入必须经 Route Handler 且先 `supabase.auth.getUser()`。

### References

- [Source: `_bmad-output/planning-artifacts/epics.md`#Story 6.1: AI 结果正负反馈闭环]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#API & Communication Patterns]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Error Handling Patterns]
- [Source: `_bmad-output/project-context.md`#AI API Route 固定模式（所有 AI 端点必须遵循）]
- [Source: `writeteam/src/app/api/ai/feedback/route.ts`]
- [Source: `writeteam/src/components/ai/ai-toolbar.tsx`]
- [Source: `writeteam/src/lib/ai/openai-stream.ts`]
- [Source: `writeteam/supabase/migrations/002_ai_quality_observability.sql`]

## Developer Context Section

### Technical Requirements

- 反馈写入必须与具体 AI 响应绑定：`response_fingerprint` 不可缺失，且仅允许 `rating` 为 `1 | -1`。
- 同一条响应反馈只允许一次，重复提交应返回可解释错误而非静默覆盖。
- 反馈流程不可影响创作主链路：提交失败不应清空生成结果，不应阻断“插入编辑器/替换选区”。
- 所有用户可见反馈文案保持中文，错误动作可执行（重试/稍后再试）。

### Architecture Compliance

- 继续遵循 Route Handler 固定链路：auth check -> 参数校验 -> 数据写入 -> JSON 响应。
- 不新增并行反馈表；沿用 `ai_history` 承载反馈字段，避免与 6.2/6.3 查询口径分叉。
- 保持 RLS 边界：反馈更新必须命中 `user_id = auth.uid()` 数据范围。
- 保持 Next.js 16 `proxy.ts` 约定，不引入 `middleware.ts`。

### Library / Framework Requirements

- Next.js 16: 保持 App Router 路由处理方式，错误返回使用 `Response.json(...)` 统一包络。
- React 19: 前端反馈交互保持局部状态可预测更新，避免提交态与结果态竞争。
- Supabase SSR: 服务端鉴权与写入继续走 `@/lib/supabase/server` 客户端；不得在客户端直接写反馈。

### File Structure Requirements

- 反馈 API 仅在 `src/app/api/ai/feedback/route.ts` 演进，不新增重复 `feedback-v2` 路由。
- 编辑器反馈 UI 统一收敛在 `src/components/ai/ai-toolbar.tsx`，避免在多个组件重复实现点赞/点踩。
- 测试命名与同目录共置：`route.test.ts`、`ai-toolbar.*.test.tsx`。

### Testing Requirements

- 路由测试覆盖 4 类：401 未登录、400 参数非法、404 无匹配响应、200 成功反馈。
- 组件测试覆盖 3 类：反馈成功 UI 变更、反馈失败提示、提交中禁用与单次提交限制。
- 增加“不中断写作”断言：反馈过程中，插入/替换操作入口仍可用或可在完成后立即继续。

## Git Intelligence Summary

- 最近 5 次提交都遵循“故事文件 + sprint-status + 代码/测试同步更新”的模式，当前故事应保持同样交付结构。
- 近期实现强调失败恢复与可追溯约束（见 4-3、4-4、5-2），本故事需延续该策略到反馈链路，避免只做 UI 不做数据约束。
- 近期高相关文件反复出现 `ai-toolbar.tsx`、`route.ts`、`*.test.ts(x)`，说明“先复用现有组件/路由，再补测试”的实践已稳定。

## Latest Tech Information

- Next.js 16 已稳定，App Router 生产应用需遵循异步 Request APIs 与 `proxy.ts` 约定；本项目现有约束与该方向一致。  
  参考: https://nextjs.org/docs/app/guides/upgrading/version-16
- React 19.2 关注可预测更新与副作用边界，反馈类 UI 应避免状态竞争导致重复提交。  
  参考: https://react.dev/blog/2025/10/01/react-19-2
- Supabase SSR 官方建议在服务端通过 `getUser()` 做真实鉴权，不在服务端依赖 `getSession()`；本故事需保持该安全基线。  
  参考: https://supabase.com/docs/guides/auth/server-side/creating-a-client
- Supabase RLS 建议策略应显式使用 `auth.uid()` 约束用户数据边界，反馈更新必须命中当前用户记录。  
  参考: https://supabase.com/docs/guides/database/postgres/row-level-security

## Project Context Reference

- [Source: `_bmad-output/project-context.md`#Technology Stack & Versions]
- [Source: `_bmad-output/project-context.md`#Critical Don't-Miss Rules]
- [Source: `_bmad-output/project-context.md`#Security Rules]
- [Source: `_bmad-output/project-context.md`#Framework-Specific Rules (Next.js 16 / React 19)]

## Story Completion Status

- Story status 设置为：`done`
- Completion note：code-review 已修复 High/Medium 问题并完成回归验证

## Dev Agent Record

### Agent Model Used

openai/gpt-5.3-codex

### Debug Log References

- create-story: 已加载并执行 `workflow.yaml`、`instructions.xml`、`template.md`、`checklist.md`、`workflow.xml`。
- create-story: 已从 `sprint-status.yaml` 自动发现首个 backlog 故事键 `6-1-ai-结果正负反馈闭环`。
- create-story: 已完成 `epics.md`、`architecture.md`、`prd.md`、`ux-design-specification.md`、`project-context.md` 与代码现状的交叉分析。
- create-story: 已完成 git 最近提交模式分析与外部技术情报补充（Next.js/React/Supabase 官方资料）。
- dev-story: 已加固 `POST /api/ai/feedback` 的参数解析、幂等返回语义与统一错误包络。
- dev-story: 已在 `AIToolbar` 增强反馈失败可执行提示，且保持写作插入/替换链路不受阻断。
- dev-story: 已执行 `npm run test`、`npm run lint`、`npm run build`，全部通过（lint 仅现存 2 条 `<img>` warning）。

### Completion Notes List

1. 已生成 Story 6.1 的完整开发上下文，覆盖需求、实现边界、测试门禁、架构守卫。
2. 已明确复用策略：优先复用现有 `/api/ai/feedback` 与 `AIToolbar.submitFeedback`，避免重复实现。
3. 已补齐面向 Epic 6 后续故事（6.2/6.3）的数据约束与可观测性约束。
4. 已完成反馈路由加固：无效 JSON/参数统一 400 错误包络，重复反馈返回 409，未命中响应返回 404。
5. 已完成编辑器反馈闭环：成功即时提示；失败提示“请重试或稍后再试”；不清空结果且可继续插入编辑器。
6. 已验证数据库约束与索引可用：`ai_history_user_rating_check`、`idx_ai_history_fingerprint`、`idx_ai_history_user_rating`。
7. 已新增并通过测试：`feedback` 路由测试 6 条、`AIToolbar` 反馈交互测试 3 条。
8. 已完成代码审查修复：反馈写入由“范围更新”改为“单记录更新”；重复反馈回传 `existingRating`；测试脚本支持按文件聚焦运行。

### File List

- `_bmad-output/implementation-artifacts/6-1-ai-结果正负反馈闭环.md`（新增）
- `_bmad-output/implementation-artifacts/sprint-status.yaml`（更新：`6-1-ai-结果正负反馈闭环` -> `in-progress` -> `review` -> `done`）
- `writeteam/src/app/api/ai/feedback/route.ts`（更新）
- `writeteam/src/app/api/ai/feedback/route.test.ts`（新增）
- `writeteam/src/components/ai/ai-toolbar.tsx`（更新）
- `writeteam/src/components/ai/ai-toolbar.feedback.test.tsx`（新增）
- `writeteam/package.json`（更新）
- `writeteam/scripts/run-tests.mjs`（新增）

### Change Log

- 2026-02-28：完成 Story 6.1 开发、测试与质量门禁，状态切换为 `review`。
- 2026-02-28：完成 code-review 修复并复测通过，状态切换为 `done`。

### Senior Developer Review (AI)

- Outcome: **Approve**
- Summary:
  - 已修复高优先级问题：`POST /api/ai/feedback` 改为先定位单条匹配记录，再按 `id` 原子更新，避免多行误更新。
  - 已修复中优先级问题：前端处理 `ALREADY_RATED` 时优先使用服务端 `existingRating`，避免按钮态与真实历史反馈不一致。
  - 已修复中优先级问题：`npm run test -- <file>` 由 `scripts/run-tests.mjs` 接管，避免 `node --test` 在 `.ts/.tsx` 参数下误执行。
- Verification:
  - `npm run test -- src/app/api/ai/feedback/route.test.ts src/components/ai/ai-toolbar.feedback.test.tsx` 通过。
  - `npm run test` 全量通过（包含 vitest 与 `tests/story-4-2-quick-edit.test.mjs`）。
  - `npm run lint` 通过（0 error，2 条既有 `<img>` warning）。
  - `npm run build` 通过。
