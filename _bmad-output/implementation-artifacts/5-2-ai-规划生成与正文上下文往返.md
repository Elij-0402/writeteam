# Story 5.2: AI 规划生成与正文上下文往返

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 创作者用户,
I want 让 AI 生成规划节点并与正文创作双向联动,
so that 我可以从规划快速进入成文并保持上下文一致。

## Acceptance Criteria

1. **Given** 用户在 Canvas 中选择生成规划，**When** AI 返回节点建议并被用户采纳，**Then** 新节点可在画布中编辑并与正文创作入口关联。
2. **Given** 用户从画布进入编辑器，**When** 用户完成写作或中途返回画布，**Then** 必要上下文被保留且画布状态不丢失。
3. **Given** AI 规划生成或联动流程失败，**When** 系统反馈错误，**Then** 用户可执行恢复动作（重试/切换模型/继续手动编辑）且不丢当前进度。

## Tasks / Subtasks

- [x] Task 1: 打通 Canvas 规划生成闭环（AC: 1, 3）
  - [x] 1.1 复用 `canvas-generate` 路由与 `callOpenAIJson`，补齐输入校验、错误语义与结果稳健解析。
  - [x] 1.2 在 `canvas-editor` 中保留“生成前预览/确认采纳”或等价机制，避免盲目落库导致脏数据。
  - [x] 1.3 生成后节点可继续通过既有节点详情面板编辑，保持 5.1 的交互一致性。
- [x] Task 2: 建立 Canvas -> Editor 的上下文跳转（AC: 1, 2）
  - [x] 2.1 在 `canvas` 侧提供“去写作/在编辑器中继续”入口，并传递项目 + 节点上下文锚点。
  - [x] 2.2 在 `editor` 侧解析联动上下文并提供可见提示（例如来源节点、摘要、可插入内容）。
  - [x] 2.3 保证无上下文参数时不影响现有编辑器主流程。
- [x] Task 3: 建立 Editor -> Canvas 返回与状态连续性（AC: 2, 3）
  - [x] 3.1 从编辑器返回画布时恢复最近关注节点/视口或等价上下文。
  - [x] 3.2 对失败链路提供明确恢复动作，不清空用户已编辑内容。
  - [x] 3.3 联动状态与提示文案保持中文且一致。
- [x] Task 4: 验证与门禁（AC: all）
  - [x] 4.1 补充至少一条 Canvas 生成主路径 + 一条失败恢复路径测试。
  - [x] 4.2 补充至少一条 Canvas↔Editor 往返上下文保持测试（可组件级 + Action 级组合）。
  - [x] 4.3 执行 `npm run lint`、`npm run build`，并记录结果。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 将 AI 预览采纳改为失败自动回滚机制，避免“部分落库 + 重试重复写入”。[`writeteam/src/components/canvas/canvas-editor.tsx:305`]
- [x] [AI-Review][MEDIUM] 在 `canvas-generate` 路由中将 `request.json()` 放入异常保护并返回可恢复中文错误语义。[`writeteam/src/app/api/ai/canvas-generate/route.ts:78`]
- [x] [AI-Review][MEDIUM] 对生成节点 `type` 增加白名单约束（beat/scene/character/location/note），防止脏数据写入。[`writeteam/src/app/api/ai/canvas-generate/route.ts:26`]
- [x] [AI-Review][MEDIUM] 统一故事状态记录，修正“Status: review”与“ready-for-dev”矛盾。[`_bmad-output/implementation-artifacts/5-2-ai-规划生成与正文上下文往返.md:3`]
- [x] [AI-Review][LOW] 将 Canvas 页返回编辑器入口由原生 `<a>` 改为 App Router `Link`，减少整页刷新。[`writeteam/src/app/(editor)/canvas/[id]/page.tsx:45`]

## Dev Notes

- 本故事建立在 Story 5.1 已完成的 Canvas 节点/边 CRUD 与保存恢复能力之上，不重复实现基础画布能力。
- 本故事核心是“AI 规划节点生成 + 与正文双向联动 + 失败可恢复”，不是新建并行编辑器/并行画布系统。
- 严格复用当前 BYOK 与 AI 路由管线：`auth -> resolveAIConfig -> fetchStoryContext -> buildStoryPromptContext -> callOpenAIJson/createOpenAIStreamResponse`。

### Project Structure Notes

- 主变更落点优先：
  - `writeteam/src/components/canvas/canvas-editor.tsx`
  - `writeteam/src/components/canvas/canvas-toolbar.tsx`
  - `writeteam/src/app/api/ai/canvas-generate/route.ts`
  - `writeteam/src/components/editor/editor-shell.tsx`
  - `writeteam/src/app/(editor)/canvas/[id]/page.tsx`
  - `writeteam/src/app/actions/canvas.ts`（仅在联动数据或恢复动作需要服务端能力时）
- 禁止新增平行目录（如新的 `flow/graph/editor-v2`）；沿用现有 `components/canvas` 与 `components/editor` 分层。

### References

- [Source: `_bmad-output/planning-artifacts/epics.md`#Epic 5: 可视化规划与正文联动]
- [Source: `_bmad-output/planning-artifacts/epics.md`#Story 5.2: AI 规划生成与正文上下文往返]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#API & Communication Patterns]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Project Structure & Boundaries]
- [Source: `_bmad-output/planning-artifacts/ux-design-specification.md`#失败恢复不断流（差异化关键路径）]
- [Source: `_bmad-output/project-context.md`#Framework-Specific Rules (Next.js 16 / React 19)]

## Developer Context Section

### Technical Requirements

- AI 生成节点必须走服务端路由并受鉴权保护，禁止在客户端直接调用第三方模型端点。
- 生成节点落库后必须立即可编辑，且与现有节点/边状态一致，不出现“画布显示成功但数据库未落地”的分叉。
- Canvas 到 Editor 的上下文必须可追踪（至少包含来源节点标识或摘要）；Editor 返回 Canvas 时需能恢复关键上下文。
- 所有失败场景必须给出可执行动作：重试、切换模型、手动继续，不允许仅报错。

### Architecture Compliance

- Route Handler 与 Server Action 继续执行 `supabase.auth.getUser()` 门禁。
- 保持 OpenAI-compatible 适配方式，沿用现有 AI 配置头与 `resolveAIConfig`。
- 继续遵守 RLS 与 `project_id + user_id` 双维度隔离，严禁跨项目节点引用。
- 保持 Next.js 16 `proxy.ts` 约定，不引入 `middleware.ts`。

### Library / Framework Requirements

- Next.js App Router + React 19：联动参数处理与页面跳转保持当前 App Router 模式。
- `@xyflow/react`：沿用当前版本与现有 `CanvasEditor` 节点/边状态管理方式，不在此故事中升级库版本。
- Supabase SSR：服务端与客户端客户端实例分离（`@/lib/supabase/server` vs `@/lib/supabase/client`）。
- AI 调用：非流式 JSON 生成使用 `callOpenAIJson`，并保持错误语义中文化。

### File Structure Requirements

- 画布交互在 `src/components/canvas/` 聚合；编辑器联动在 `src/components/editor/` 承接。
- 服务端读写与校验在 `src/app/actions/canvas.ts` 或对应 route handler，UI 组件不直接访问数据库。
- 复用已有类型 `CanvasNode`/`CanvasEdge`（`src/types/database.ts`），禁止平行类型体系。

### Testing Requirements

- 增加 Canvas 生成成功路径测试：生成节点数量、节点字段、自动连线行为（如保留）至少覆盖一条。
- 增加失败恢复测试：AI 返回格式错误、路由错误或 Action 错误时，验证可见提示与重试动作。
- 增加联动测试：Canvas -> Editor 上下文传递、Editor -> Canvas 返回后的状态连续性。
- 完成后执行 `npm run lint` 与 `npm run build`。

## Previous Story Intelligence

- 5.1 已沉淀可复用能力：节点/边 CRUD、连接去重、重连、失效边修复、位置保存回滚、保存失败重试。
- 5.1 的关键经验：
  - 失败时必须提供“重试保存/刷新重载”等可执行动作；
  - 连线与节点引用一致性必须由服务端校验；
  - 移动端可达性需保证关键触控区域。
- 对 5.2 的直接约束：
  - 不要绕过 `createCanvasNode/createCanvasEdge` 直接拼前端假数据；
  - 不要新造独立恢复机制，复用现有保存状态与重试路径；
  - 不要破坏 5.1 已通过测试的节点/边行为。

## Git Intelligence Summary

- 最近提交显示 Epic 4 与 5 的实现模式已稳定：
  - 先补齐失败恢复链路，再补组件/路由测试；
  - 统一在故事文件与 `sprint-status.yaml` 同步状态；
  - 画布能力集中在 `actions/canvas.ts` + `components/canvas/*`。
- 最近与 5.2 高相关文件：
  - `writeteam/src/components/canvas/canvas-editor.tsx`
  - `writeteam/src/app/actions/canvas.ts`
  - `writeteam/src/app/(editor)/canvas/[id]/page.tsx`
  - `writeteam/src/components/editor/editor-shell.tsx`
- 可执行策略：沿用已有错误语义与测试门禁，不重构大范围模块。

## Latest Tech Information

- Next.js App Router 官方模式下，页面间状态/参数传递应基于路由参数与可序列化数据，复杂客户端瞬态状态应本地管理并在刷新后可恢复到合理默认。[Source: https://nextjs.org/docs/app]
- React 19 保持以组件本地状态 + 可预测更新为主，事件驱动的异步流程应确保失败分支可回退并清理中间态。[Source: https://react.dev/]
- React Flow（`@xyflow/react` v12）推荐继续使用 `useNodesState/useEdgesState` 与受控更新模式，避免在复杂交互下产生不可预测分叉状态。[Source: https://reactflow.dev/]
- OpenAI-compatible 非流式 JSON 调用建议维持严格响应校验与兜底解析失败处理，避免将无效结构写入业务数据层。[Source: `writeteam/src/lib/ai/openai-json.ts`, `writeteam/src/app/api/ai/canvas-generate/route.ts`]

## Project Context Reference

- [Source: `_bmad-output/project-context.md`#Technology Stack & Versions]
- [Source: `_bmad-output/project-context.md`#Critical Implementation Rules]
- [Source: `_bmad-output/project-context.md`#Framework-Specific Rules (Next.js 16 / React 19)]
- [Source: `_bmad-output/project-context.md`#Critical Don't-Miss Rules]

## Story Completion Status

- Story status 设置为：`done`
- Completion note：Ultimate context engine analysis completed - comprehensive developer guide created

## Senior Developer Review (AI)

### Review Date

- 2026-02-28

### Reviewer

- Elij（AI 对抗式审查）

### Outcome

- Auto-fixed（HIGH/MEDIUM/LOW 全部修复）

### Scope & Validation Evidence

- Story 与实现文件逐项交叉审查：`route.ts`、`route.test.ts`、`canvas-editor.tsx`、`canvas-editor.test.tsx`、`canvas-toolbar.tsx`、`node-detail-panel.tsx`、`editor-shell.tsx`、`editor/[id]/page.tsx`、`canvas/[id]/page.tsx`
- Git 对照：故事 File List 与 `git diff --name-only` 一致，无遗漏文件差异
- 质量门禁：`npm run lint`（0 error, 2 warning，均为既有 `visualize-panel.tsx` 的 `<img>` 提示）、`npm run build` 通过
- 测试验证：`npx vitest run src/app/api/ai/canvas-generate/route.test.ts src/components/canvas/canvas-editor.test.tsx`，2 文件 10 用例全部通过
- 外部参考检索：基于 Next.js App Router 与 React Flow 受控状态实践进行一致性核验（来源已在本故事“Latest Tech Information”记录）

### Findings Summary

- HIGH: 0（已修复）
- MEDIUM: 0（已修复）
- LOW: 0（已修复）

### AC Audit

- AC1：IMPLEMENTED（Canvas 生成、预览采纳、编辑入口已覆盖）
- AC2：IMPLEMENTED（Canvas -> Editor 上下文传递与 Editor -> Canvas 聚焦恢复已覆盖）
- AC3：IMPLEMENTED（失败恢复包含重试/切换模型/继续手动编辑，且采纳失败自动回滚）

## Dev Agent Record

### Agent Model Used

openai/gpt-5.3-codex

### Debug Log References

- create-story: 已加载并执行 `workflow.yaml`、`instructions.xml`、`template.md`、`checklist.md`、`workflow.xml`。
- create-story: 使用用户指定故事键 `5-2-ai-规划生成与正文上下文往返` 完成目标故事解析。
- create-story: 已完成 `epics.md`、`architecture.md`、`prd.md`、`ux-design-specification.md`、`project-context.md` 与 `sprint-status.yaml` 全量读取与提取。
- create-story: 已提取前序故事 `5-1` 的实现经验与 git 最近提交模式作为实现守卫。
- dev-story: 完成 `canvas-generate` 输入校验与稳健解析，新增路由测试覆盖参数错误与格式错误恢复。
- dev-story: 完成 Canvas AI 生成“先预览后采纳”闭环，避免直接落库造成脏数据。
- dev-story: 完成 Canvas -> Editor 上下文跳转与 Editor 提示条，支持节点摘要快速插入。
- dev-story: 完成 Editor -> Canvas 返回节点焦点恢复（focusNodeId），并新增组件测试覆盖。
- dev-story: 已执行 `npm run test`、`npx vitest run src/app/api/ai/canvas-generate/route.test.ts`、`npm run lint`、`npm run build`。
- code-review-fix: 已完成 HIGH/MEDIUM 自动修复（采纳失败回滚、JSON 解析保护、节点类型白名单、状态文档一致性）。
- code-review-fix: 已新增/更新测试，验证非法 JSON 输入、非法 type 兜底、采纳失败回滚链路。
- code-review-fix: 已完成 LOW 修复（Canvas 顶栏返回入口切换到 Next `Link`）。

### Completion Notes List

1. 已产出 Story 5.2 的完整开发上下文，覆盖需求、任务拆解、架构与测试守卫。
2. 已明确复用边界：沿用 5.1 的画布能力，不重造节点/边基础设施。
3. 已定义 Canvas↔Editor 双向联动与失败恢复的实现约束，防止范围漂移。
4. 已实现 Canvas AI 生成预览采纳机制：预览不落库，确认后顺序创建节点与连线。
5. 已实现失败恢复动作：重试、切换模型、继续手动编辑，且不清空用户已有编辑状态。
6. 已实现双向联动上下文：节点面板“去写作”带节点锚点，编辑器支持返回画布并恢复焦点。
7. 测试与门禁：`npm run test` 全量通过；新增 `canvas-generate/route.test.ts` 通过；`npm run build` 通过；`npm run lint` 无错误（存在既有 warning：`visualize-panel.tsx` 中 `img` 提示）。

### File List

- `_bmad-output/implementation-artifacts/5-2-ai-规划生成与正文上下文往返.md`（新增）
- `_bmad-output/implementation-artifacts/sprint-status.yaml`（更新：`5-2-ai-规划生成与正文上下文往返` -> `in-progress` -> `review` -> `done`）
- `writeteam/src/app/api/ai/canvas-generate/route.ts`（修改：输入校验、错误语义、稳健节拍解析）
- `writeteam/src/app/api/ai/canvas-generate/route.test.ts`（新增：主路径与错误恢复测试）
- `writeteam/src/components/canvas/canvas-editor.tsx`（修改：预览采纳、恢复动作、去写作上下文跳转）
- `writeteam/src/components/canvas/canvas-editor.test.tsx`（修改：新增非法类型兜底与采纳失败回滚测试）
- `writeteam/src/components/canvas/canvas-toolbar.tsx`（修改：预览采纳/丢弃操作）
- `writeteam/src/components/canvas/node-detail-panel.tsx`（修改：新增“去写作”入口）
- `writeteam/src/app/(editor)/editor/[id]/page.tsx`（修改：解析 Canvas 上下文参数并注入 EditorShell）
- `writeteam/src/components/editor/editor-shell.tsx`（修改：显示来源节点提示、插入摘要、返回画布）
- `writeteam/src/app/(editor)/canvas/[id]/page.tsx`（修改：接收 focusNodeId 并恢复节点焦点）
- `writeteam/src/components/canvas/canvas-editor.test.tsx`（修改：预览采纳、失败恢复、上下文恢复测试）
- `writeteam/src/app/(editor)/canvas/[id]/page.tsx`（修改：返回编辑器入口由 `<a>` 改为 `Link`）

## Change Log

- 2026-02-28: 完成 Story 5.2 开发与测试，补齐 Canvas 规划生成稳健性、Canvas↔Editor 双向上下文、失败恢复动作与门禁验证。
- 2026-02-28: 完成 BMAD code-review 对抗式审查，新增 `Review Follow-ups (AI)`，状态调整为 `in-progress`，并记录审查结论与证据。
- 2026-02-28: 执行“自动修复”并完成 HIGH/MEDIUM 问题收敛，补充回滚与白名单防护测试，故事状态更新为 `done`。
- 2026-02-28: 修复剩余 LOW 审查项（Canvas 页返回入口改为 Next Link），评审跟进项全部完成。
