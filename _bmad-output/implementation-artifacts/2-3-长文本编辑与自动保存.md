# Story 2.3: 长文本编辑与自动保存

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 创作者用户,
I want 在编辑器中稳定编辑长文本并自动保存,
so that 我不会因刷新或中断而丢失写作进度。

## Acceptance Criteria

1. **Given** 用户正在编辑文档正文，**When** 用户持续输入、格式化和切换面板，**Then** 系统按节流策略自动保存并保持编辑器状态一致（内容、字数、当前文档上下文），并且不出现明显卡顿（FR6, NFR1, NFR3）。
2. **Given** 用户在 5 万字量级文档中写作，**When** 触发自动保存与侧边面板切换，**Then** 常规编辑操作交互延迟维持在可接受范围（目标对齐 NFR：编辑交互 P95 <= 100ms，面板切换卡顿 <= 200ms），不因保存逻辑导致光标跳动或输入中断（NFR1, NFR3）。
3. **Given** 自动保存过程中出现失败（网络抖动、权限失效、服务端错误），**When** 保存失败被检测，**Then** 界面必须显示中文可执行状态反馈（如重试/继续编辑提示），且不清空当前编辑内容（NFR12）。
4. **Given** 用户刷新页面、离开后返回或切换设备继续写作，**When** 文档重新载入，**Then** 最近成功保存内容可恢复，且文档列表/激活文档状态保持一致，不跨项目串数据（FR6, NFR6）。
5. **Given** 用户通过键盘与输入法进行连续写作，**When** 自动保存在后台运行，**Then** 写作主链路可持续，关键反馈可感知且不打断输入（NFR9, NFR10）。

## Tasks / Subtasks

- [x] **Task 1: 审核并固化现有自动保存链路（以现有实现为基线补强）**（AC: 1, 3, 4）
  - [x] 1.1 盘点 `editor-shell` 与 `writing-editor` 当前 autosave 触发路径、状态字段与调用边界。
  - [x] 1.2 确保自动保存节流策略与现有约束一致（1s debounce），禁止引入更短频率。
  - [x] 1.3 明确保存成功/失败/进行中三态在 UI 的一致表达，并统一中文文案。
  - [x] 1.4 失败路径保证“不丢当前编辑内容”，并提供可执行下一步（重试或继续编辑）。

- [x] **Task 2: 强化长文本性能与编辑连续性**（AC: 1, 2, 5）
  - [x] 2.1 在不改动核心架构前提下优化重渲染边界，避免非编辑区状态变更导致编辑器频繁重渲染。
  - [x] 2.2 检查并修正可能影响输入连续性的状态更新时机（例如 autosave 状态闪烁、频繁 setState）。
  - [x] 2.3 验证侧栏/面板切换与自动保存并发下的编辑稳定性，必要时做局部隔离（组件拆分或 memo）。
  - [x] 2.4 保持 TipTap 内容持久化双写约束：`content`（JSON）+ `content_text`（纯文本镜像）+ `word_count` 同步一致。

- [x] **Task 3: 恢复与一致性保障**（AC: 3, 4）
  - [x] 3.1 刷新/重进后恢复最近成功保存内容，确保 `activeDocId` 与列表状态一致。
  - [x] 3.2 校验跨项目切换时隔离边界（`project_id` + `user_id`），防止错误复用上一个项目编辑态。
  - [x] 3.3 明确离线/异常下的“可继续写作”体验：允许本地继续输入，并持续给出状态反馈。

- [x] **Task 4: 交付验证与回归**（AC: all）
  - [x] 4.1 运行 `npm run lint`，确保无新增 lint 错误。
  - [x] 4.2 运行 `npm run build`，确保生产构建通过。
  - [x] 4.3 手动验证：连续输入 + 面板切换 + 自动保存状态提示。
  - [x] 4.4 手动验证：模拟保存失败场景，确认中文提示与内容不丢失。
  - [x] 4.5 手动验证：刷新/重进恢复与跨项目隔离行为。

### Review Follow-ups (AI)

- [x] [AI-Review][Critical] 已修复：导入链路补齐 `content` / `content_text` / `word_count` 三字段同步（新增 `buildTiptapDocFromText` + 统一字数计算）（`writeteam/src/components/editor/editor-shell.tsx:83`, `writeteam/src/components/editor/editor-shell.tsx:210`）。
- [x] [AI-Review][High] 已修复：文档切换时清理旧 autosave 定时器并失效旧请求，避免旧文档状态污染新文档（`writeteam/src/components/editor/writing-editor.tsx:108`）。
- [x] [AI-Review][High] 已修复：统一 `word_count` 统计口径（导入与编辑均使用同一 `countWords` 逻辑），消除统计漂移（`writeteam/src/components/editor/editor-shell.tsx:74`, `writeteam/src/components/editor/writing-editor.tsx:54`）。
- [x] [AI-Review][Medium] 已修复：`persistDraft` 增加异常兜底，`onUpdate` reject 时返回中文错误态并可继续重试（`writeteam/src/components/editor/writing-editor.tsx:83`）。
- [x] [AI-Review][Medium] 已补证据：完成 Playwright 手测并归档截图/网络日志/快照报告，覆盖 Task 4.3/4.4/4.5（`_bmad-output/implementation-artifacts/evidence-story-2-3-autosave-2026-02-28/story-2-3-autosave-verification-report.md`）。

## Dev Notes

- 这是 Epic 2 的连续故事，前置 Story 2.1、2.2 已完成项目与文档管理闭环；本 Story 聚焦“编辑器主链路稳定性与自动保存可靠性”，不引入新业务域。
- 按项目规则，自动保存节流保持 **1 秒防抖**，不要缩短；Saliency 仍保持 5 秒防抖，避免写作性能退化。
- 本 Story 不新增 AI 能力，不改动 AI 路由固定链路；重点在编辑器与文档写入路径的稳定性。
- 用户可见反馈全部中文，错误信息必须给可执行动作，禁止“只报错不指路”。

### Project Structure Notes

#### 预计修改文件
| 文件 | 路径 | 变更 |
|------|------|------|
| editor-shell.tsx | `writeteam/src/components/editor/` | 主编辑容器状态管理、文档切换与保存状态反馈联动 |
| writing-editor.tsx | `writeteam/src/components/editor/` | TipTap 编辑事件、autosave 触发与输入连续性优化 |
| documents.ts | `writeteam/src/app/actions/` | 必要时仅做最小化保存动作增强（鉴权/错误包络保持一致） |

#### 不应修改的文件
- `writeteam/src/proxy.ts`（认证代理约定已稳定，与本 Story 无关）
- `writeteam/src/lib/ai/*`（本 Story 不涉及 AI 调用链）
- `writeteam/src/types/database.ts`（若无字段新增，不应改动）

### References

- [Source: `_bmad-output/planning-artifacts/epics.md`#Story 2.3: 长文本编辑与自动保存]
- [Source: `_bmad-output/planning-artifacts/prd.md`#FR6]
- [Source: `_bmad-output/planning-artifacts/prd.md`#NFR1]
- [Source: `_bmad-output/planning-artifacts/prd.md`#NFR3]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Frontend Architecture]
- [Source: `_bmad-output/planning-artifacts/architecture.md`#Implementation Patterns & Consistency Rules]
- [Source: `_bmad-output/planning-artifacts/ux-design-specification.md`#失败恢复不断流（差异化关键路径）]
- [Source: `_bmad-output/project-context.md`#Performance Gotchas]
- [Source: `_bmad-output/project-context.md`#Testing Rules]

## Developer Context Section

### Technical Requirements

- 必须沿用现有 Next.js 16 + React 19 + TypeScript strict 技术栈，不引入与自动保存无关的新依赖。
- 所有写入路径必须遵循 Server Action 固定模式：`"use server"` + `supabase.auth.getUser()` + 中文错误返回。
- 保存失败不得覆盖或清空编辑器当前内容；失败状态需可见且可恢复。
- 自动保存节流策略保持 1s debounce，不得提高触发频率。
- 文档持久化保持三字段一致：`content`（TipTap JSON）/ `content_text`（纯文本）/ `word_count`。

### Architecture Compliance

- 组件边界遵循既有分层：
  - 编辑交互在 `src/components/editor/*`
  - 数据写入在 `src/app/actions/*`
  - 页面层负责装配，不承载写入业务
- 数据访问继续依赖 RLS 隔离与 `user_id = auth.uid()`，禁止绕过。
- 不创建 `middleware.ts`，项目使用 `proxy.ts` 约定。
- 保持 monorepo 约定：应用代码仅位于 `writeteam/src/`。

### Library / Framework Requirements

- Next.js 16.1.x（App Router，`proxy.ts` 约定）
- React 19.2.x（编辑器隔离渲染，避免无关重渲染）
- TipTap 3.20.x（建议持久化 JSON 为主；集成层关注渲染隔离与性能）
- Supabase JS 2.x + RLS（公开 schema 表必须启用 RLS，策略使用 `auth.uid()`）
- shadcn/ui + sonner（统一状态反馈）

### File Structure Requirements

- 默认变更范围：
  - `writeteam/src/components/editor/editor-shell.tsx`
  - `writeteam/src/components/editor/writing-editor.tsx`
  - `writeteam/src/app/actions/documents.ts`（仅在确有必要时）
- 保持 kebab-case 命名与现有目录结构。
- 不新增与本 Story 无关的 API Route。

### Testing Requirements

- 基线验证：`npm run lint` + `npm run build`。
- 关键手测：
  - 长文本连续输入下 autosave 状态是否稳定可见
  - 面板切换与 autosave 并发时是否出现卡顿/丢焦点
  - 保存失败时是否中文提示且内容不丢
  - 刷新/重进恢复是否正确
  - 跨项目切换是否隔离

## Previous Story Intelligence

- 来自 Story 2.2 的可复用经验：
  - 优先做“增量改造”，避免无关重构；
  - 保持中文错误语义与可执行反馈；
  - 对并发操作做防重入与失败回滚；
  - 提交前执行 lint + build 作为硬门禁。
- Story 2.2 已引入文档排序原子更新与一致性修复，当前 Story 需在其基础上确保编辑态与持久化态同步，不破坏已建立的数据一致性。

## Git Intelligence Summary

- 最近提交表明 Epic 2 已完成 Story 2.1、2.2，当前应延续相同实现风格：
  - 小步增量、少文件改动；
  - 优先复用既有 actions 和组件模式；
  - 所有用户可见提示中文化；
  - 交付前强制 lint/build。
- 近期与编辑器相关改动集中在 `editor-shell.tsx` 与 `documents.ts`，本 Story 应优先在这些既有落点补强。

## Latest Tech Information

- Next.js 官方文档已明确 `middleware` 迁移为 `proxy` 文件约定；本项目已采用该模式，Story 实现不得回退旧约定。 [Source: https://nextjs.org/docs/app/api-reference/file-conventions/proxy]
- Supabase 官方文档强调：暴露 schema 表必须启用 RLS，并使用 `auth.uid()` 做行级授权；本 Story 的任何保存/读取路径都必须遵守。 [Source: https://supabase.com/docs/guides/database/postgres/row-level-security]
- Tiptap 官方建议持久化以 JSON 为优先，并在 React 集成时隔离编辑器渲染边界以避免性能问题；与本项目 `content` JSON 存储策略一致。 [Source: https://tiptap.dev/docs/editor/core-concepts/persistence] [Source: https://tiptap.dev/docs/guides/performance]

## Project Context Reference

- [Source: `_bmad-output/project-context.md`#Performance Gotchas]
- [Source: `_bmad-output/project-context.md`#Framework-Specific Rules (Next.js 16 / React 19)]
- [Source: `_bmad-output/project-context.md`#Critical Don't-Miss Rules]
- [Source: `_bmad-output/project-context.md`#Testing Rules]

## Story Completion Status

- Story status 已设置为：`done`
- Completion note：代码审查问题与手测证据均已闭环，Story 2.3 达到完成标准。

## Senior Developer Review (AI)

### Review Metadata

- Review Date: 2026-02-28
- Reviewer: Elij
- Outcome: Approved

### Findings Summary

| Severity | Count |
|---|---:|
| High | 0 |
| Medium | 0 |
| Low | 0 |

### Fixes Applied

- 已关闭 Critical/High/Medium 共 5 项（含手测证据补录）。
- 修复后已通过 `lsp_diagnostics`（`editor-shell.tsx`、`writing-editor.tsx`）、`npm run lint`（0 error）与 `npm run build`。

### Acceptance Criteria Cross-check

- AC1: Implemented（自动保存状态与文档上下文一致性修复完成）。
- AC2: Implemented（长文本下渲染边界与统计一致性问题已修复）。
- AC3: Implemented（失败提示、重试与 reject 兜底已覆盖）。
- AC4: Implemented（代码路径与手测证据均满足）。
- AC5: Implemented（后台 autosave 不阻断输入链路，状态反馈可感知）。

### Git vs Story Discrepancy Check

- 已核对 story File List 与 git 变更：无“文件声明与实际改动不一致”问题。

### Validation Notes

- MCP/文档检索：已使用官方 Tiptap 文档作为核验参考（Persistence 与 Performance 指南）。
- 诊断检查：`lsp_diagnostics`（`writeteam/src/components/editor/editor-shell.tsx`、`writeteam/src/components/editor/writing-editor.tsx`）均为 0 问题。
- 构建验证：`npm run lint`（0 error，2 个既有 warning）与 `npm run build` 通过。
- 手测证据：`_bmad-output/implementation-artifacts/evidence-story-2-3-autosave-2026-02-28/story-2-3-autosave-verification-report.md`（含 3 个场景截图、网络日志与页面快照）。

## Dev Agent Record

### Agent Model Used

gpt-5.3-codex

### Debug Log References

- create-story workflow: 解析 `sprint-status.yaml` 首个 backlog 故事为 `2-3-长文本编辑与自动保存`。
- create-story workflow: 已读取并分析 epics / prd / architecture / ux / project-context / previous story / recent git commits。
- dev-story workflow: 已读取并执行 `workflow.yaml`、`instructions.xml`、`checklist.md` 全流程步骤。
- dev-story workflow: 完成 `writing-editor.tsx` autosave 三态 UI 与失败重试链路；`editor-shell.tsx` 按保存结果更新本地状态。
- dev-story workflow: 运行 `npm run lint` 与 `npm run build`；尝试 `npm test`，项目未配置 test script。

### Completion Notes List

- 已完成：目标故事自动发现与编号解析（epic=2, story=3）。
- 已完成：从 Epic/PRD/NFR/UX/架构中提取故事约束并映射为开发任务。
- 已完成：抽取 Story 2.2 经验作为当前 Story 的实现护栏。
- 已完成：补充最新技术参考（Next.js proxy、Supabase RLS、TipTap 持久化与性能）。
- 已完成：输出可直接交给 `dev-story` 的实现上下文。
- 已完成：保持 autosave 1 秒防抖，新增“保存中/已保存/保存失败”中文状态反馈与“立即重试”动作。
- 已完成：保存失败不再错误更新本地文档快照，避免“看起来已保存但服务端失败”的状态漂移。
- 已完成：将 `WritingEditor` 用 `memo` 包裹并稳定 `onUpdate` 回调，降低右侧面板切换造成的编辑区重渲染风险。
- 已验证：`npm run lint`（仅存在既有 warning，无新增 error）与 `npm run build` 通过。
- 说明：当前仓库未配置自动化测试脚本（`npm test` 缺失），本次按故事基线完成 lint/build 与实现级回归验证。

### File List

- `_bmad-output/implementation-artifacts/2-3-长文本编辑与自动保存.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `writeteam/src/components/editor/writing-editor.tsx`
- `writeteam/src/components/editor/editor-shell.tsx`

### Change Log

- 2026-02-28: 完成 Story 2.3 实现。补强 autosave 失败可恢复路径与三态可视反馈，保证 1s 防抖不变；同步优化编辑器渲染稳定性并更新 sprint/story 状态为 `review`。
- 2026-02-28: 执行 BMAD `code-review`；新增 `Review Follow-ups (AI)` 与 `Senior Developer Review (AI)`，并将故事状态调整为 `in-progress`。
- 2026-02-28: 按 `code-review` 结果完成代码修复（Critical/High/Medium 可修复项已关闭），并完成 lint/build 与 LSP 复核；保留 1 项手测证据待补。
- 2026-02-28: 补齐 Story 2.3 手测证据（Playwright 场景 A/B/C），关闭最后一项 Medium follow-up，状态更新为 `done`。
